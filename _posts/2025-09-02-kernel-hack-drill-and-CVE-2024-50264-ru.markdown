---
layout: post
title: "[ru] Kernel-hack-drill –∏ –Ω–æ–≤—ã–π —ç–∫—Å–ø–ª–æ–π—Ç –¥–ª—è CVE-2024-50264 –≤ —è–¥—Ä–µ Linux"
date: 2025-10-03 13:37:00 +0300
---

–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ–º –ø–∞–º—è—Ç–∏, –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ —Å–ª–æ–∂–Ω—ã –¥–ª—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏. –û–Ω–∏ –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥–æ–Ω–∫–∏, –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ —Å–±–æ—è–º —Å–∏—Å—Ç–µ–º—ã –∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —É—Å–ª–æ–∂–Ω—è—é—Ç –∂–∏–∑–Ω—å –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è. –†–∞–±–æ—Ç–∞ —Å —Ç–∞–∫–∏–º–∏ ¬´—Ö—Ä—É–ø–∫–∏–º–∏¬ª –±–∞–≥–∞–º–∏ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ —É—Å–∏–ª–∏–π. CVE-2024-50264 –≤ —è–¥—Ä–µ Linux ‚Äî –∫–∞–∫ —Ä–∞–∑ –æ–¥–Ω–∞ –∏–∑ —Ç–∞–∫–∏—Ö —Å–ª–æ–∂–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–ª—É—á–∏–ª–∞ –ø—Ä–µ–º–∏—é Pwnie Award 2025 –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬´–õ—É—á—à–µ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π¬ª (Best Privilege Escalation). –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—é —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç [kernel-hack-drill](https://github.com/a13xp0p0v/kernel-hack-drill) –∏ –ø–æ–∫–∞–∂—É, –∫–∞–∫ –æ–Ω –ø–æ–º–æ–≥ –º–Ω–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø —ç–∫—Å–ø–ª–æ–π—Ç–∞ –¥–ª—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ CVE-2024-50264.

## –ò—Å—Ç–æ—Ä–∏—è –æ–± –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏

–í 2021 –≥–æ–¥—É —è –æ–±–Ω–∞—Ä—É–∂–∏–ª —É—è–∑–≤–∏–º–æ—Å—Ç—å –≤ –ø–æ–¥—Å–∏—Å—Ç–µ–º–µ `AF_VSOCK` —è–¥—Ä–∞ Linux –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª –æ–± —ç—Ç–æ–º —Å—Ç–∞—Ç—å—é ¬´[–°–∏–ª–∞ —á–µ—Ç—ã—Ä–µ—Ö –±–∞–π—Ç–æ–≤: —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ CVE-2021-26708 –≤ —è–¥—Ä–µ Linux](https://a13xp0p0v.github.io/2021/06/09/CVE-2021-26708-ru.html)¬ª. –°–ø—É—Å—Ç—è 3 –≥–æ–¥–∞, –≤ –∞–ø—Ä–µ–ª–µ 2024-–≥–æ, —è —Ä–µ—à–∏–ª —Å–Ω–æ–≤–∞ –ø–æ–∑–∞–Ω–∏–º–∞—Ç—å—Å—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ–º `AF_VSOCK` –∏ –Ω–∞—à–µ–ª –µ—â–µ –æ–¥–∏–Ω —Å–±–æ–π —è–¥—Ä–∞ –º–µ—Ç–æ–¥–æ–º –ø—Ä–∏—Ü–µ–ª—å–Ω–æ–≥–æ —Ñ–∞–∑–∑–∏–Ω–≥–∞ —Å –ø–æ–º–æ—â—å—é –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–∑–∑–µ—Ä–∞ syzkaller. –Ø —Å–¥–µ–ª–∞–ª –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–ø—Ä–æ–¥—é—Å–µ—Ä, –ø—Ä–∏–≤–æ–¥—è—â–∏–π –∫ –æ—Ç–∫–∞–∑—É —è–¥—Ä–∞, –æ—Ç–∫–ª—é—á–∏–ª —Å–∞–Ω–∏—Ç–∞–π–∑–µ—Ä KASAN –∏ –æ–±–Ω–∞—Ä—É–∂–∏–ª, —á—Ç–æ –±–∞–≥ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É —Ä–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏—é –Ω—É–ª–µ–≤–æ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª—è –≤ —Ä–∞–±–æ—á–µ–º –ø–æ—Ç–æ–∫–µ —è–¥—Ä–∞ (null-ptr-deref –≤ `kworker`). –≠—Ç–æ –≤—ã–≥–ª—è–¥–µ–ª–æ –Ω–µ –æ—á–µ–Ω—å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ–π —Ü–µ–ª—å—é –¥–ª—è –∞—Ç–∞–∫—É—é—â–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π. –ö—Ä–æ–º–µ —Ç–æ–≥–æ, —è –≤—ã—è—Å–Ω–∏–ª, —á—Ç–æ —ç—Ç–∞ –æ—à–∏–±–∫–∞ –≤—ã–∑–≤–∞–Ω–∞ —Å–ª–æ–∂–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≥–æ–Ω–∫–∏ (race condition) –∏ –¥–ª—è –µ–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω—É–∂–Ω–∞ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã `AF_VSOCK`. –í –∏—Ç–æ–≥–µ —è –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –æ—Ç–ª–æ–∂–∏–ª —ç—Ç–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ. –ê –∑—Ä—è.

–ü–æ–∑–∂–µ, –æ—Å–µ–Ω—å—é 2024 –≥–æ–¥–∞ —è —Ä–µ—à–∏–ª —Å–Ω–æ–≤–∞ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —ç—Ç–æ—Ç –±–∞–≥ –∏ –ø–æ–ª—É—á–∏–ª –æ–±–Ω–∞–¥–µ–∂–∏–≤–∞—é—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. –ù–æ —Ç–∏—Ö–∏–º –Ω–æ—è–±—Ä—å—Å–∫–∏–º –≤–µ—á–µ—Ä–æ–º —è –æ–±–Ω–∞—Ä—É–∂–∏–ª, —á—Ç–æ –•—ë–Ω–≤—É –ö–∏–º ([@v4bel](https://x.com/v4bel)) –∏ –í–æ–Ω–≥–∏ –õ–∏ ([@qwerty](https://x.com/_qwerty_po)) —É–∂–µ —Å–æ–æ–±—â–∏–ª–∏ –æ–± —ç—Ç–æ–π —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (CVE-2024-50264) –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –µ–µ –Ω–∞ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–∏ kernelCTF. [–ò—Ö –ø–∞—Ç—á](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/net/vmw_vsock?id=6ca575374dd9a507cdd16dfa0e78c2e9e20bd05f) –Ω–µ –∏—Å–ø—Ä–∞–≤–∏–ª —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏, –Ω–æ –≤—Å–µ –∂–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª –º–æ–π PoC-—ç–∫—Å–ø–ª–æ–π—Ç –≤ null-ptr-deref:

<center><img src="/img/vsock_patch.png" width="90%"></center><br>

–°—Ä–µ–¥–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —ç—Ç–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è bug collision. –õ—é–±–æ–π, –∫—Ç–æ –ø–æ–ø–∞–¥–∞–ª –≤ —Ç–∞–∫—É—é —Å–∏—Ç—É–∞—Ü–∏—é, –º–æ–∂–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å, —á—Ç–æ —è –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª. –í–æ–∑–Ω–∏–∫ –≤–æ–ø—Ä–æ—Å, —á—Ç–æ –º–Ω–µ –¥–µ–ª–∞—Ç—å: –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–∑—É—á–∞—Ç—å —ç—Ç—É —É—è–∑–≤–∏–º–æ—Å—Ç—å –∏–ª–∏ —Å–º–∏—Ä–∏—Ç—å—Å—è –∏ –æ—Å—Ç–∞–≤–∏—Ç—å –µ–µ?

<center><img src="/img/Vityaz.jpg" width="80%"><br>–í–∏–∫—Ç–æ—Ä –í–∞—Å–Ω–µ—Ü–æ–≤. ¬´–í–∏—Ç—è–∑—å –Ω–∞ —Ä–∞—Å–ø—É—Ç—å–µ¬ª (1882)</center><br>

[–°—Ç—Ä–∞—Ç–µ–≥–∏—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏](https://github.com/google/security-research/pull/145/files) –æ—Ç @v4bel –∏ @qwerty –≤—ã–≥–ª—è–¥–µ–ª–∞ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ–π. –£ –º–µ–Ω—è –±—ã–ª–∏ —Å–≤–æ–∏ –∏–¥–µ–∏, –ø–æ—ç—Ç–æ–º—É —è —Ä–µ—à–∏–ª –≤—Å–µ-—Ç–∞–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ. –í –∫–∞—á–µ—Å—Ç–≤–µ —Ü–µ–ª–∏ –¥–ª—è PoC-—ç–∫—Å–ø–ª–æ–π—Ç–∞ —è –≤—ã–±—Ä–∞–ª Ubuntu Server 24.04 —Å–æ —Å–≤–µ–∂–∏–º —è–¥—Ä–æ–º OEM/HWE (v6.11).

## –ê–Ω–∞–ª–∏–∑ CVE-2024-50264

–£—è–∑–≤–∏–º–æ—Å—Ç—å [CVE-2024-50264](https://nvd.nist.gov/vuln/detail/CVE-2024-50264) –±—ã–ª–∞ –ø—Ä–∏–≤–Ω–µ—Å–µ–Ω–∞ –≤ –∫–æ–¥ —è–¥—Ä–∞ Linux v4.8 –∫–æ–º–º–∏—Ç–æ–º [06a8fc78367d](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/net/vmw_vsock?id=06a8fc78367d070720af960dcecec917d3ae5f3b) –≤ –∞–≤–≥—É—Å—Ç–µ 2016 –≥–æ–¥–∞. –≠—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —Å–æ–∫–µ—Ç–æ–≤ `AF_VSOCK`, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–Ω—ã–º –≤—ã–∑–æ–≤–æ–º `connect()` –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π POSIX-—Å–∏–≥–Ω–∞–ª–æ–≤, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è (use-after-free, UAF). –≠—Ç–∞ —É—è–∑–≤–∏–º–æ—Å—Ç—å –æ—Å–æ–±–æ –æ–ø–∞—Å–Ω–∞, –ø–æ—Å–∫–æ–ª—å–∫—É –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å –µ–µ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π, –Ω–µ –∑–∞–¥–µ–π—Å—Ç–≤—É—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏–º–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (user namespaces).

–Ø–¥—Ä–æ –æ—à–∏–±–æ—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç `virtio_vsock_sock`, —Ä–∞–∑–º–µ—Ä –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 80 –±–∞–π—Ç, —á—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫—ç—à—É `kmalloc-96` —Å–ª—ç–±-–∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞ (—è —Ä–µ—à–∏–ª –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å slab allocator —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –ø–æ—Å–∫–æ–ª—å–∫—É —Å–ª–æ–≤–æ ¬´—Å–ª—ç–±¬ª —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –¥–µ—Ä–µ–≤–æ–æ–±—Ä–∞–±–æ—Ç–∫–µ üòä). –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –∑–∞–ø–∏—Å—å –ø–æ—Å–ª–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è (UAF-write), –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–∞—è –≤ —Ä–∞–±–æ—á–µ–º –ø–æ—Ç–æ–∫–µ —è–¥—Ä–∞ (kernel worker).

–û–¥–Ω–∞–∫–æ —É —ç—Ç–æ–π —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –µ—Å—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–ª—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π, **—ç—Ç–æ —Å–∞–º—ã–π –Ω–µ—É–¥–æ–±–Ω—ã–π –¥–ª—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –±–∞–≥ –∏–∑ –≤—Å–µ—Ö, —á—Ç–æ —è –∫–æ–≥–¥–∞-–ª–∏–±–æ –≤–∏–¥–µ–ª**. –ù–µ—Å–ø—Ä–æ—Å—Ç–∞ –æ–Ω –ø–æ–ª—É—á–∏–ª Pwnie Award. –î–∞–ª–µ–µ —è –ø–æ–¥—Ä–æ–±–Ω–æ —Ä–∞—Å—Å–∫–∞–∂—É –æ–± —ç—Ç–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö.

## –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —Å –ø–æ–º–æ—â—å—é ¬´–±–µ—Å—Å–º–µ—Ä—Ç–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞¬ª

–ò—Ç–∞–∫, —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–æ–∫–µ—Ç (server vsock):
```c
#define UAF_PORT 0x2712

int ret = -1;
int vsock1 = 0;
struct sockaddr_vm addr = {
	.svm_family = AF_VSOCK,
	.svm_port = UAF_PORT,
	.svm_cid = VMADDR_CID_LOCAL
};

vsock1 = socket(AF_VSOCK, SOCK_STREAM, 0);
if (vsock1 < 0)
	err_exit("[-] creating vsock");

ret = bind(vsock1, (struct sockaddr *)&addr, sizeof(struct sockaddr_vm));
if (ret != 0)
	err_exit("[-] binding vsock");

ret = listen(vsock1, 0); /* backlog = 0 */
if (ret != 0)
	err_exit("[-] listening vsock");
```

–ó–∞—Ç–µ–º –ø—ã—Ç–∞–µ–º—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –Ω–∏–º –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–æ–∫–µ—Ç–∞ (client vsock):
```c
int vsock2 = 0;

vsock2 = socket(AF_VSOCK, SOCK_STREAM, 0);
if (vsock2 < 0)
	err_exit("[-] creating vsock");

ret = connect(vsock2, (struct sockaddr *)&addr, sizeof(struct sockaddr_vm));
```

–ß—Ç–æ–±—ã —Å–ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å –±–∞–≥, –Ω—É–∂–Ω–æ –ø—Ä–µ—Ä–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ `connect()` —Å –ø–æ–º–æ—â—å—é POSIX-—Å–∏–≥–Ω–∞–ª–∞. –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–∏ @v4bel –∏ @qwerty –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ `SIGKILL`, –Ω–æ –æ–Ω —É–±–∏–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —ç–∫—Å–ø–ª–æ–π—Ç–∞. –ú–æ–π —Ñ–∞–∑–∑–µ—Ä –Ω–∞—à–µ–ª –±–æ–ª–µ–µ —Ö–∏—Ç—Ä—ã–π —Å–ø–æ—Å–æ–±, –∫–æ—Ç–æ—Ä—ã–π –º–µ–Ω—è —É–¥–∏–≤–∏–ª:

```c
struct sigevent sev = {};
timer_t race_timer = 0;

sev.sigev_notify = SIGEV_SIGNAL;
sev.sigev_signo = 33;
ret = timer_create(CLOCK_MONOTONIC, &sev, &race_timer);
```

–§–∞–∑–∑–µ—Ä –æ–±–Ω–∞—Ä—É–∂–∏–ª, —á—Ç–æ —Ç–∞–π–º–µ—Ä –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–≥–Ω–∞–ª 33, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ—Ä–≤–µ—Ç `connect()`. –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å —Å–∏–≥–Ω–∞–ª–∞ 33 –≤ —Ç–æ–º, —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Native POSIX Threads Library (NPTL) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –Ω—É–∂–¥, –∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—Ç –Ω–µ–≥–æ. –í —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–µ (`man 7 nptl`) —á–∏—Ç–∞–µ–º:

>NPTL makes internal use of the first two real-time signals (signal numbers 32 and 33).
One of these signals is used to support thread cancellation and POSIX timers (see `timer_create(2)`); the other is used as part of a mechanism that ensures all threads in a process always have the same UIDs and GIDs, as required by POSIX. These signals cannot be used in applications.

–í–µ—Ä–Ω–æ, —ç—Ç–∏ —Å–∏–≥–Ω–∞–ª—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –Ω–æ –æ–Ω–∏ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –º–æ–µ–≥–æ —ç–∫—Å–ø–ª–æ–π—Ç–∞ üòâ

<center><img src="/img/secret-ru.jpg" width="50%"></center><br>

–î–ª—è —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞ `race_timer` —è –∏—Å–ø–æ–ª—å–∑—É—é `timer_settime()`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–Ω—ã–π –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Å–∏–≥–Ω–∞–ª 33 –¥–æ–ª–∂–µ–Ω –ø—Ä–µ—Ä–≤–∞—Ç—å —É—è–∑–≤–∏–º—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ `connect()`. –ë–æ–ª–µ–µ —Ç–æ–≥–æ, —ç—Ç–æ—Ç —Å–∏–≥–Ω–∞–ª –Ω–µ–≤–∏–¥–∏–º –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —ç–∫—Å–ø–ª–æ–π—Ç–∞ –∏ –Ω–µ –≤—Ä–µ–¥–∏—Ç –µ–º—É.

## –û –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–∏ –ø–∞–º—è—Ç–∏

–°–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç, –∫–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ `connect()` –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è —Å–∏–≥–Ω–∞–ª–æ–º. –ï—Å–ª–∏ –ø—Ä–∏ —ç—Ç–æ–º —É—è–∑–≤–∏–º—ã–π —Å–æ–∫–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `TCP_ESTABLISHED`, —Ç–æ –æ–Ω [–ø–µ—Ä–µ—Ö–æ–¥–∏—Ç](https://elixir.bootlin.com/linux/v6.11.7/source/net/vmw_vsock/af_vsock.c#L1475) –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `TCP_CLOSING`:

```c
if (signal_pending(current)) {
	err = sock_intr_errno(timeout);
	sk->sk_state = sk->sk_state == TCP_ESTABLISHED ? TCP_CLOSING : TCP_CLOSE;
	sock->state = SS_UNCONNECTED;
	vsock_transport_cancel_pkt(vsk);
	vsock_remove_connected(vsk);
	goto out_wait;
}
```

–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —É—è–∑–≤–∏–º—ã–π vsock, –Ω–∞—Ö–æ–¥—è—â–∏–π—Å—è –≤ —Ç–∞–∫–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –∫ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º—É vsock —Å –¥—Ä—É–≥–∏–º `svm_cid` (`VMADDR_CID_HYPERVISOR`) –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—é –ø–∞–º—è—Ç–∏.

```c
struct sockaddr_vm addr = {
	.svm_family = AF_VSOCK,
	.svm_port = UAF_PORT,
	.svm_cid = VMADDR_CID_HYPERVISOR
};

/* this connect will schedule the kernel worker performing UAF */
ret = connect(vsock2, (struct sockaddr *)&addr, sizeof(struct sockaddr_vm));
```

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º? –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `connect()` —è–¥—Ä–æ [–≤—ã–∑—ã–≤–∞–µ—Ç](https://elixir.bootlin.com/linux/v6.11.7/source/net/vmw_vsock/af_vsock.c#L439) —Ñ—É–Ω–∫—Ü–∏—é `vsock_assign_transport()`. –û–Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–æ–∫–µ—Ç –Ω–∞ –Ω–æ–≤—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç `svm_cid` –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º vsock-—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º:
```c
if (vsk->transport) {
	if (vsk->transport == new_transport)
		return 0;

	/* transport->release() must be called with sock lock acquired.
	 * This path can only be taken during vsock_connect(), where we
	 * have already held the sock lock. In the other cases, this
	 * function is called on a new socket which is not assigned to
	 * any transport.
	 */
	vsk->transport->release(vsk);
	vsock_deassign_transport(vsk);
}
```

–í —Ö–æ–¥–µ —ç—Ç–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤ `virtio_transport_close()` [–∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è](https://elixir.bootlin.com/linux/v6.11.7/source/net/vmw_vsock/virtio_transport_common.c#L1214) —Å—Ç–∞—Ä—ã–π vsock-—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –∏ –≤ `virtio_transport_destruct()` [–æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è](https://elixir.bootlin.com/linux/v6.11.7/source/net/vmw_vsock/virtio_transport_common.c#L1085) –æ–±—ä–µ–∫—Ç `virtio_vsock_sock`. –û–¥–Ω–∞–∫–æ –∏–∑-–∑–∞ –æ—à–∏–±–æ—á–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–∫–µ—Ç–∞ (`TCP_CLOSING`) —Ñ—É–Ω–∫—Ü–∏—è `virtio_transport_close()` –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –¥–∞–ª—å–Ω–µ–π—à–∏–π –æ–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏. –î–ª—è –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ —è–¥—Ä–æ –ø—Ä–æ–±—É–∂–¥–∞–µ—Ç –ø–æ—Ç–æ–∫ `kworker`, –∏ –æ–Ω [–æ–±—Ä–∞—â–∞–µ—Ç—Å—è](https://elixir.bootlin.com/linux/v6.11.7/source/net/vmw_vsock/virtio_transport_common.c#L1434) –∫ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `virtio_transport_space_update()`:

```c
static bool virtio_transport_space_update(struct sock *sk, struct sk_buff *skb)
{
	struct virtio_vsock_hdr *hdr = virtio_vsock_hdr(skb);
	struct vsock_sock *vsk = vsock_sk(sk);
	struct virtio_vsock_sock *vvs = vsk->trans; /* ptr to freed object */
	bool space_available;

	if (!vvs)
		return true;

	spin_lock_bh(&vvs->tx_lock); /* proceed if 4 bytes are zero (UAF write non-zero to lock) */
	vvs->peer_buf_alloc = le32_to_cpu(hdr->buf_alloc); /* UAF write 4 bytes */
	vvs->peer_fwd_cnt = le32_to_cpu(hdr->fwd_cnt); /* UAF write 4 bytes */
	space_available = virtio_transport_has_space(vsk); /* UAF read, not interesting */
	spin_unlock_bh(&vvs->tx_lock); /* UAF write, restore 4 zero bytes */
	return space_available;
}
```

–ù–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ö–µ–º–µ –ø–æ–∫–∞–∑–∞–Ω–æ, –∫–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç UAF –Ω–∞ —É—è–∑–≤–∏–º–æ–º –æ–±—ä–µ–∫—Ç–µ `virtio_vsock_sock`:

<center><img src="/img/uaf_write.png"></center><br>

–ñ–µ–ª—Ç—ã–º —Ü–≤–µ—Ç–æ–º –≤—ã–¥–µ–ª–µ–Ω–æ –ø–æ–ª–µ `tx_lock`, –∫–æ—Ç–æ—Ä–æ–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–≤–Ω–æ –Ω—É–ª—é. –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ —è–¥—Ä–æ –∑–∞–≤–∏—Å–Ω–µ—Ç –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å —Å–ø–∏–Ω–ª–æ–∫ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `virtio_transport_space_update()`. –ö—Ä–∞—Å–Ω—ã–º —Ü–≤–µ—Ç–æ–º –æ—Ç–º–µ—á–µ–Ω—ã –ø–æ–ª—è `peer_buf_alloc` –∏ `peer_fwd_cnt`, –≤ –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∑–∞–ø–∏—Å—å –ø–æ—Å–ª–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è (UAF-write). –†–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏—è —É–∫–∞–∑–∞—Ç–µ–ª–µ–π –≤ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ –Ω–µ—Ç.

–ó–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –ø–æ–ª–µ `virtio_vsock_sock.peer_buf_alloc`, –∞—Ç–∞–∫—É—é—â–∏–π –º–æ–∂–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞:

```c
/* Increase the range for the value that we want to write during UAF: */
uaf_val_limit = 0x1lu; /* can't be zero */
setsockopt(vsock1, PF_VSOCK, SO_VM_SOCKETS_BUFFER_MIN_SIZE,
           &uaf_val_limit, sizeof(uaf_val_limit));
uaf_val_limit = 0xfffffffflu;
setsockopt(vsock1, PF_VSOCK, SO_VM_SOCKETS_BUFFER_MAX_SIZE,
           &uaf_val_limit, sizeof(uaf_val_limit));

/* Set the 4-byte value that we want to write during UAF: */
setsockopt(vsock1, PF_VSOCK, SO_VM_SOCKETS_BUFFER_SIZE,
           &uaf_val, sizeof(uaf_val));
```

–ê –≤ –ø–æ–ª–µ `virtio_vsock_sock.peer_fwd_cnt` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–π—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã —á–µ—Ä–µ–∑ vsock —Å –ø–æ–º–æ—â—å—é `sendmsg()`/`recvmsg()`. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–Ω–æ —Ä–∞–≤–Ω–æ –Ω—É–ª—é (—á–µ—Ç—ã—Ä–µ –Ω—É–ª–µ–≤—ã—Ö –±–∞–π—Ç–∞).

## –†–∞–Ω–æ —Ä–∞–¥–æ–≤–∞—Ç—å—Å—è: —É CVE-2024-50264 –µ—Å—Ç—å —Å–µ—Ä—å–µ–∑–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

–ö–∞–∫ —è —É–∂–µ —É–ø–æ–º–∏–Ω–∞–ª, —É —ç—Ç–æ–π —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –º–∞—Å—Å–∞ –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã—Ö –Ω—é–∞–Ω—Å–æ–≤, —É—Å–ª–æ–∂–Ω—è—é—â–∏—Ö —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é:

1. –£—è–∑–≤–∏–º—ã–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –æ–±—ä–µ–∫—Ç `virtio_vsock_sock` —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Å–µ—Ä–≤–µ—Ä–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º. –í—ã–¥–µ–ª–µ–Ω–∏–µ –∏—Ö –≤ –æ–¥–Ω–æ–º —Å–ª—ç–±–µ –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫—É (cross-cache attack).
2. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –æ—á–µ–Ω—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ.
3. –ó–∞–ø–∏—Å—å –≤ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ kworker —Å–ø—É—Å—Ç—è –≤—Å–µ–≥–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ `kfree()`. –≠—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∏.
4. –ü–æ—Å–ª–µ UAF-–∑–∞–ø–∏—Å–∏ –≤ kworker –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏–µ –Ω—É–ª–µ–≤–æ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª—è (null-ptr-deref). –≠—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞, –∏–∑-–∑–∞ –∫–æ—Ç–æ—Ä–æ–π —è –ø–æ–Ω–∞—á–∞–ª—É –æ—Ç–ª–æ–∂–∏–ª —ç—Ç–æ—Ç –±–∞–≥.
5. –î–∞–∂–µ –µ—Å–ª–∏ —É–¥–∞–µ—Ç—Å—è –∏–∑–±–µ–∂–∞—Ç—å —ç—Ç–æ–≥–æ –æ—Ç–∫–∞–∑–∞ —è–¥—Ä–∞, —á–µ—Ä–µ–∑ `VSOCK_CLOSE_TIMEOUT` (–≤–æ—Å–µ–º—å —Å–µ–∫—É–Ω–¥) –≤ kworker –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –µ—â–µ –æ–¥–Ω–æ —Ä–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏–µ –Ω—É–ª–µ–≤–æ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª—è.
6. –ü—Ä–∏ —ç—Ç–æ–º kworker –∑–∞–≤–∏—Å–∞–µ—Ç –≤ `spin_lock_bh()`, –µ—Å–ª–∏ –ø–æ–ª–µ `virtio_vsock_sock.tx_lock` –Ω–µ–Ω—É–ª–µ–≤–æ–µ, –∫–∞–∫ —É–ø–æ–º–∏–Ω–∞–ª–æ—Å—å –≤—ã—à–µ.

–†–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—è PoC-—ç–∫—Å–ø–ª–æ–π—Ç –¥–ª—è CVE-2024-50264, —è –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–ª —ç—Ç–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –æ–¥–Ω–æ –∑–∞ –¥—Ä—É–≥–∏–º. –Ø –¥—É–º–∞—é, –∏–º–µ–Ω–Ω–æ –∏–∑-–∑–∞ –Ω–∏—Ö —ç—Ç–æ—Ç –±–∞–≥ –ø–æ–ª—É—á–∏–ª Pwnie Award 2025 –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬´–õ—É—á—à–µ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π¬ª (Best Privilege Escalation).

<center><img src="/img/mario-ru.jpg" width="80%"></center><br>

## –†–∞–∑–º—ã—à–ª–µ–Ω–∏—è –æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏

–í–æ—Ç –ø–ª–∞–Ω –∞—Ç–∞–∫–∏ @v4bel –∏ @qwerty, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑–∞–ª—Å—è –º–Ω–µ –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–º:

1. –°–æ–∑–¥–∞—Ç—å –æ–≥—Ä–æ–º–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ BPF-–ø—Ä–æ–≥—Ä–∞–º–º (BPF JIT spraying), —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∏–º–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—É—é —á–∞—Å—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏.
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å [—Ç–µ—Ö–Ω–∏–∫—É SLUBStick](https://github.com/IAIK/SLUBStick) –æ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π –ì—Ä–∞—Ü—Å–∫–æ–≥–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞, —á—Ç–æ–±—ã:
  - –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —Å–ª—ç–±–µ —Å –ø–æ–º–æ—â—å—é —É—Ç–µ—á–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –ø–æ–±–æ—á–Ω–æ–º—É –∫–∞–Ω–∞–ª—É –ø–æ –≤—Ä–µ–º–µ–Ω–∏.
  - –ó–∞—Ç–µ–º —Ä–∞–∑–≤–µ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç—ã `virtio_vsock_sock` –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ —Ä–∞–∑–Ω—ã–º —Å–ª—ç–±–∞–º, —Å–æ–∑–¥–∞–≤ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç –≤ –∫–æ–Ω—Ü–µ –æ–¥–Ω–æ–≥–æ —Å–ª—ç–±–∞, –∞ –¥—Ä—É–≥–æ–π –æ–±—ä–µ–∫—Ç ‚Äî –≤ –Ω–∞—á–∞–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ.
3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫—É [Dirty Page Table](https://web.archive.org/web/20250226150503/https://yanglingxi1993.github.io/dirty_pagetable/dirty_pagetable.html), —á—Ç–æ–±—ã —á–µ—Ä–µ–∑ UAF-–æ–±—ä–µ–∫—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ —Å—Ç—Ä–∞–Ω–∏—Ü (Page Table Entry, PTE).
4. –ù–∞—É–¥–∞—á—É –∏–∑–º–µ–Ω–∏—Ç—å PTE, —á—Ç–æ–±—ã –æ–Ω–∞ —Å—Ç–∞–ª–∞ —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø–∞–º—è—Ç—å —Å BPF-–∫–æ–¥–æ–º. –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ç–æ–≥–æ, —á—Ç–æ —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ –∏ –æ–±—ä–µ–º–∞ BPF JIT spraying.
5. –í–Ω–µ–¥—Ä–∏—Ç—å –≤ BPF-–∫–æ–¥ –ø–æ–ª–µ–∑–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π.
6. –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–µ–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è BPF-–ø—Ä–æ–≥—Ä–∞–º–º–∞, —á—Ç–æ–±—ã –ø–æ–≤—ã—Å–∏—Ç—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–µ.

<center><img src="/img/grumpy12-ru.jpeg" width="80%"></center><br>

–Ø —á—É–≤—Å—Ç–≤–æ–≤–∞–ª, —á—Ç–æ –º–æ–π PoC-—ç–∫—Å–ø–ª–æ–π—Ç –¥–ª—è CVE-2024-50264 –±—É–¥–µ—Ç –Ω–∞–º–Ω–æ–≥–æ –ø—Ä–æ—â–µ. –ò–¥–µ—è –±—ã–ª–∞ —Å–ª–µ–¥—É—é—â–∞—è: –Ω–∞–ø—Ä–∞–≤–∏—Ç—å UAF-–∑–∞–ø–∏—Å—å –≤ —Ç–∞–∫–æ–π —è–¥–µ—Ä–Ω—ã–π –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–º–æ–∂–µ—Ç –¥–∞—Ç—å –ø–æ–ª–µ–∑–Ω—ã–π –¥–ª—è –∞—Ç–∞–∫–∏ —ç–∫—Å–ø–ª–æ–π—Ç-–ø—Ä–∏–º–∏—Ç–∏–≤.

–Ø –Ω–µ —Å—Ç–∞–ª –∏—Å–∫–∞—Ç—å –æ–±—ä–µ–∫—Ç-–∂–µ—Ä—Ç–≤—É (victim object) –≤ —Ç–æ–º –∂–µ –∫—ç—à–µ `kmalloc-96`, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤ Ubuntu Server 24.04 –≤–∫–ª—é—á–µ–Ω—ã —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞—â–∏—Ç—ã –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–π—Ç—Ä–∞–ª–∏–∑—É—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ç–µ—Ö–Ω–∏–∫—É heap spraying –¥–ª—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ UAF:
- –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ `CONFIG_SLAB_BUCKETS=y` —è–¥—Ä–æ —Å–æ–∑–¥–∞–µ—Ç –Ω–∞–±–æ—Ä –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–ª—ç–±-–∫—ç—à–µ–π –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
- –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ `CONFIG_RANDOM_KMALLOC_CACHES=y` —è–¥—Ä–æ —Å–æ–∑–¥–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–ø–∏–π —Å–ª—ç–±-–∫—ç—à–µ–π –∏ –ø—Ä–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–∏ –ø–∞–º—è—Ç–∏ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç `kmalloc()` –≤—ã–±–∏—Ä–∞—Ç—å –æ–¥–Ω—É –∏–∑ —ç—Ç–∏—Ö –∫–æ–ø–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–¥—Ä–µ—Å–∞ –∫–æ–¥–∞, –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ –¥–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é.

–≠—Ç–æ –Ω–µ –¥–∞–µ—Ç –∞—Ç–∞–∫—É—é—â–µ–º—É –≤—ã–ø–æ–ª–Ω–∏—Ç—å heap spraying –∏ —Ä–∞—Å–ø–æ–ª–æ–∂–∏—Ç—å –Ω—É–∂–Ω—ã–π –æ–±—ä–µ–∫—Ç –Ω–∞ –º–µ—Å—Ç–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω–æ–≥–æ –≤ —Ç–æ–º –∂–µ —Å–ª—ç–±–µ. –ü–æ—ç—Ç–æ–º—É —è —Ä–µ—à–∏–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫—É, —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞—â–∏—Ç—ã –∏ –∫ —Ç–æ–º—É –∂–µ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å —Å–µ–±—è –≤ –≤—ã–±–æ—Ä–µ —Ü–µ–ª–µ–π –¥–ª—è UAF-–∑–∞–ø–∏—Å–∏.

–í –∫–∞—á–µ—Å—Ç–≤–µ –ø–µ—Ä–≤–æ–π –∂–µ—Ä—Ç–≤—ã —è –≤–∑—è–ª –æ–±—ä–µ–∫—Ç `cred`. –ï–≥–æ —Ä–∞–∑–º–µ—Ä ‚Äî 184 –±–∞–π—Ç–∞, –∏ –∞–ª–ª–æ–∫–∞—Ç–æ—Ä –≤—ã–¥–µ–ª—è–µ—Ç —Ç–∞–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã –≤ —Å–ª—ç–±–∞—Ö, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã—Ö –Ω–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –ø–æ 192 –±–∞–π—Ç–∞. –ü—Ä–∏ —ç—Ç–æ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –ø–∞–º—è—Ç–∏, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Ä–∞—Å–ø–æ–ª–∞–≥–∞—é—Ç—Å—è —É—è–∑–≤–∏–º—ã–µ –æ–±—ä–µ–∫—Ç—ã `virtio_vsock_sock`, –≤ –¥–≤–∞ —Ä–∞–∑–∞ –º–µ–Ω—å—à–µ (96 –±–∞–π—Ç). –ü–æ—ç—Ç–æ–º—É –≤ —Ü–µ–ª–µ–≤–æ–º `cred` –≤–æ–∑–º–æ–∂–Ω–æ –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å–º–µ—â–µ–Ω–∏—è, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç UAF-–∑–∞–ø–∏—Å—å. –ù–∞ —Å—Ö–µ–º–µ –Ω–∏–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ, –∫–∞–∫ –¥–≤–∞ —É—è–∑–≤–∏–º—ã—Ö –æ–±—ä–µ–∫—Ç–∞ `virtio_vsock_sock` –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º `cred`. –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –≤ –æ–¥–Ω–æ–º –∏–∑ –æ–±—ä–µ–∫—Ç–æ–≤ `virtio_vsock_sock`.

<center><img src="/img/uaf_write_cred2.png" width="80%"></center><br>

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ `cred` –Ω–∞ –º–µ—Å—Ç–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ `virtio_vsock_sock` –Ω–µ –¥–∞–µ—Ç –∞—Ç–∞–∫—É—é—â–µ–º—É –Ω–∏–∫–∞–∫–æ–π –ø–æ–ª—å–∑—ã:
- –ï—Å–ª–∏ UAF –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –ø–µ—Ä–≤–æ–º `virtio_vsock_sock`, —è–¥—Ä–æ –∑–∞–≤–∏—Å–∞–µ—Ç –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `spin_lock_bh()`, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–∞ –º–µ—Å—Ç–µ `virtio_vsock_sock.tx_lock` –æ–±—ä–µ–∫—Ç `cred` –∏–º–µ–µ—Ç –Ω–µ–Ω—É–ª–µ–≤–æ–µ –ø–æ–ª–µ `uid`.
- –ï—Å–ª–∏ UAF –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –≤—Ç–æ—Ä–æ–º `virtio_vsock_sock`, –∑–∞–ø–∏—Å—å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ–ª–µ `virtio_vsock_sock.peer_buf_alloc` –ø–æ–≤—Ä–µ–∂–¥–∞–µ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å `cred.request_key_auth`. –ë–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π —É—Ç–µ—á–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ —è–¥—Ä–∞ —ç—Ç–æ —Ç—Ä—É–¥–Ω–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –≤ –ø–æ–ª–µ–∑–Ω—ã–π —ç–∫—Å–ø–ª–æ–π—Ç-–ø—Ä–∏–º–∏—Ç–∏–≤.

–ò—Ç–∞–∫, –æ–±—ä–µ–∫—Ç `cred` –º–Ω–µ –Ω–µ –ø–æ–¥–æ—à–µ–ª, –∏ —è —Å—Ç–∞–ª –∏—Å–∫–∞—Ç—å –¥–∞–ª—å—à–µ. –°–ª–µ–¥—É—é—â–µ–π –º–æ–µ–π –∂–µ—Ä—Ç–≤–æ–π –¥–ª—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ —Å—Ç–∞–ª `msg_msg`. –≠—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –º–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è: –≤–ø–µ—Ä–≤—ã–µ —è –ø—Ä–∏–º–µ–Ω–∏–ª –µ–≥–æ –¥–ª—è heap spraying –≤ 2021 –≥–æ–¥—É (–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ —Å—Ç–∞—Ç—å–µ ¬´[–°–∏–ª–∞ —á–µ—Ç—ã—Ä–µ—Ö –±–∞–π—Ç–æ–≤: —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ CVE-2021-26708 –≤ —è–¥—Ä–µ Linux](https://a13xp0p0v.github.io/2021/06/09/CVE-2021-26708-ru.html)¬ª). –¢–µ—Ö–Ω–∏–∫–∞ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é —è —Ç–æ–≥–¥–∞ –∏–∑–æ–±—Ä–µ–ª, —Å—Ç–∞–ª–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ–π –≤ —Å—Ä–µ–¥–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —è–¥—Ä–∞ Linux. –ò –≤ —ç—Ç–æ—Ç —Ä–∞–∑ —è —Ä–µ—à–∏–ª —Å–Ω–æ–≤–∞ –ø—Ä–∏–¥—É–º–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ —Å –æ–±—ä–µ–∫—Ç–æ–º `msg_msg`.

–î–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ —è –≤—ã–±—Ä–∞–ª 96-–±–∞–π—Ç–Ω—ã–π `msg_msg`, —á—Ç–æ–±—ã —Å–ª—ç–±-–∞–ª–ª–æ–∫–∞—Ç–æ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –¥–ª—è `msg_msg` –∏ `virtio_vsock_sock` —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã (chunks) –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏–ª–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å–º–µ—â–µ–Ω–∏–µ UAF-–∑–∞–ø–∏—Å–∏ –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞ `msg_msg`. –ù–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ö–µ–º–µ –ø–æ–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –æ–±—ä–µ–∫—Ç–æ–º `msg_msg`, —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–º –Ω–∞ –º–µ—Å—Ç–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω–æ–≥–æ `virtio_vsock_sock`:

<center><img src="/img/uaf_write_msg_msg.png" width="90%"></center><br>

`msg_msg.m_list.prev` ‚Äî —ç—Ç–æ —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—ä–µ–∫—Ç –≤ —Å–≤—è–∑–Ω–æ–º —Å–ø–∏—Å–∫–µ –≤ –∞–¥—Ä–µ—Å–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ —è–¥—Ä–∞. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ `msg_msg` —ç—Ç–æ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å —Ä–∞–≤–µ–Ω –Ω—É–ª—é (—Å–º. `CONFIG_INIT_ON_ALLOC_DEFAULT_ON`), –∞ –∑–∞—Ç–µ–º –æ–Ω –ø–æ–ª—É—á–∞–µ—Ç –Ω–µ–Ω—É–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ `msg_msg` [–ø–æ–º–µ—â–∞–µ—Ç—Å—è](https://elixir.bootlin.com/linux/v6.15.5/source/ipc/msg.c#L941) –≤ –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π. –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ—Ç –Ω–µ–Ω—É–ª–µ–≤–æ–π —É–∫–∞–∑–∞—Ç–µ–ª—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ `virtio_vsock_sock.tx_lock`, –∏–∑-–∑–∞ —á–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏—è `virtio_transport_space_update()` –∑–∞–≤–∏—Å–∞–µ—Ç –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ `spin_lock_bh()`.

–ß—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, –Ω—É–∂–Ω–æ –±—ã–ª–æ –¥–æ–±–∏—Ç—å—Å—è, —á—Ç–æ–±—ã —è–¥—Ä–æ –ø—Ä–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–æ `msg_msg.m_list.prev` —É–∂–µ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è UAF-–∑–∞–ø–∏—Å–∏. –Ø —Å—Ç–∞–ª –∏—Å–∫–∞—Ç—å —Å–ø–æ—Å–æ–± –æ—Ç–ª–æ–∂–∏—Ç—å –ø–æ–º–µ—â–µ–Ω–∏–µ `msg_msg` –≤ –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π ‚Äî –∏ –≤ –∫–æ–Ω—Ü–µ –∫–æ–Ω—Ü–æ–≤ –Ω–∞—à–µ–ª —Ä–µ—à–µ–Ω–∏–µ.

## –ù–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞: msg_msg spraying —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–æ–ª—è m_list

–Ø –ø—Ä–∏–¥—É–º–∞–ª —Å–ø–æ—Å–æ–± –≤—ã–ø–æ–ª–Ω–∏—Ç—å heap spraying –æ–±—ä–µ–∫—Ç–∞–º–∏ `msg_msg` —Ç–∞–∫, —á—Ç–æ–±—ã —è–¥—Ä–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–æ –∑–Ω–∞—á–µ–Ω–∏—è —É–∫–∞–∑–∞—Ç–µ–ª–µ–π –≤ –ø–æ–ª–µ `msg_msg.m_list` –≤ —Å–ª—É—á–∞–µ –∏—Ö –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è. –ü–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π —Ç–∞–∫–æ–π:

1. –ü–æ—á—Ç–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω—è–µ–º –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ü–µ–ª–µ–≤—ã—Ö `msg_msg`.
  - –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç `MSGMNB=16384` –±–∞–π—Ç.
  - –ß—Ç–æ–±—ã –µ–µ –∑–∞–ø–æ–ª–Ω–∏—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º 2 –±–æ–ª—å—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è-–ø—É—Å—Ç—ã—à–∫–∏ –ø–æ 8191 –±–∞–π—Ç –∫–∞–∂–¥–æ–µ, –Ω–µ –≤—ã–∑—ã–≤–∞—è –¥–ª—è –Ω–∏—Ö `msgrcv()`.
  - –¢–æ–≥–¥–∞ –≤ –æ—á–µ—Ä–µ–¥–∏ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ª–∏—à—å 2 –±–∞–π—Ç–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞.
  - –ß—Ç–æ–±—ã –æ—Ç–ª–∏—á–∞—Ç—å —ç—Ç–∏ `msg_msg` –æ—Ç —Ü–µ–ª–µ–≤—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –Ω–∏—Ö `mtype = 1`.

2. –î–∞–ª–µ–µ –Ω–∞—á–∏–Ω–∞–µ–º heap spraying: —Å–æ–∑–¥–∞–µ–º —Ü–µ–ª–µ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã `msg_msg` —Å –ø–æ–º–æ—â—å—é —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `msgsnd()`.
  - –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è —ç—Ç–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π `mtype = 2`, —á—Ç–æ–±—ã –æ—Ç–ª–∏—á–∞—Ç—å –∏—Ö –æ—Ç –ø—É—Å—Ç—ã—à–µ–∫.
  - –í—ã–∑—ã–≤–∞–µ–º `msgsnd()` –∏–∑ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö pthread-–ø–æ—Ç–æ–∫–æ–≤.
  - –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∫–∞–∂–¥–æ–≥–æ —Ç–∞–∫–æ–≥–æ –≤—ã–∑–æ–≤–∞ —è–¥—Ä–æ –≤—ã–¥–µ–ª—è–µ—Ç –ø–∞–º—è—Ç—å –ø–æ–¥ —Ü–µ–ª–µ–≤–æ–π `msg_msg`, –ø–æ—Å–ª–µ —á–µ–≥–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫ [–¥–æ —Ç–µ—Ö –ø–æ—Ä](https://elixir.bootlin.com/linux/v6.15.5/source/ipc/msg.c#L900), –ø–æ–∫–∞ –≤ –æ—á–µ—Ä–µ–¥–∏ –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞:

    ```c
    	if (msg_fits_inqueue(msq, msgsz))
    		break;
    
    	/* queue full, wait: */
    	if (msgflg & IPC_NOWAIT) {
    		err = -EAGAIN;
    		goto out_unlock0;
    	}
    
    	/* enqueue the sender and prepare to block */
    	ss_add(msq, &s, msgsz);
    
    	if (!ipc_rcu_getref(&msq->q_perm)) {
    		err = -EIDRM;
    		goto out_unlock0;
    	}
    
    	ipc_unlock_object(&msq->q_perm);
    	rcu_read_unlock();
    	schedule();
    ```

    <center><img src="/img/train_msg_msg-ru.jpg" width="80%"></center><br>

3. –ü–æ–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã `msgsnd()` –æ–∂–∏–¥–∞—é—Ç –º–µ—Å—Ç–∞ –≤ –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, –≤—ã–ø–æ–ª–Ω—è–µ–º UAF-–∑–∞–ø–∏—Å—å –≤ –Ω–∞—á–∞–ª–æ –æ–¥–Ω–æ–≥–æ –∏–∑ —Ü–µ–ª–µ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ `msg_msg`, –ø–æ–≤—Ä–µ–∂–¥–∞—è –µ–≥–æ –ø–æ–ª—è `m_list`, `m_type` –∏ `m_ts`.

4. –ü–æ—Å–ª–µ UAF-–∑–∞–ø–∏—Å–∏ –≤—ã–∑—ã–≤–∞–µ–º `msgrcv()` –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π-–ø—É—Å—Ç—ã—à–µ–∫ —Å —Ç–∏–ø–æ–º 1.

5. –í –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –º–µ—Å—Ç–æ, –∏ —è–¥—Ä–æ –ø—Ä–æ–±—É–∂–¥–∞–µ—Ç –ø–æ—Ç–æ–∫–∏, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º –≤—ã–∑–æ–≤–µ `msgsnd()`. –¢–µ–ø–µ—Ä—å —Ü–µ–ª–µ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã `msg_msg` –±–ª–∞–≥–æ–ø–æ–ª—É—á–Ω–æ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å, –∏ –ø—Ä–∏ —ç—Ç–æ–º [—è–¥—Ä–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç](https://elixir.bootlin.com/linux/v6.15.5/source/ipc/msg.c#L941) –ø–æ–ª–µ `m_list`, –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –±—ã–ª–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ –≤ –æ–¥–Ω–æ–º –∏–∑ –æ–±—ä–µ–∫—Ç–æ–≤:
 ```c
 	if (!pipelined_send(msq, msg, &wake_q)) {
 		/* no one is waiting for this message, enqueue it */
 		list_add_tail(&msg->m_list, &msq->q_messages);
 		msq->q_cbytes += msgsz;
 		msq->q_qnum++;
 		percpu_counter_add_local(&ns->percpu_msg_bytes, msgsz);
 		percpu_counter_add_local(&ns->percpu_msg_hdrs, 1);
 	}
 ```

–ì–æ—Ç–æ–≤–æ! –≠—Ç–∞ —Ç–µ—Ö–Ω–∏–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å `msg_msg` –≤—Å–ª–µ–ø—É—é, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü–µ–π –º–∞—Å—Å–∏–≤–∞ (out-of-bounds write). –ë–ª–∞–≥–æ–¥–∞—Ä—è —Ç–æ–º—É, —á—Ç–æ —è–¥—Ä–æ —Å–∞–º–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ –ø–æ–ª–µ `m_list`, –∞—Ç–∞–∫—É—é—â–µ–º—É –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–µ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —è–¥–µ—Ä–Ω—ã—Ö –∞–¥—Ä–µ—Å–∞—Ö. –ê –≤ –º–æ–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ—Ç —Ç—Ä—é–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∑–≤–æ–ª–∏–ª –∏–∑–±–µ–∂–∞—Ç—å –∑–∞–≤–∏—Å–∞–Ω–∏—è `virtio_transport_space_update()` –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ `spin_lock_bh()`:

<center><img src="/img/uaf_write_msg_msg2.png" width="90%"></center><br>

–ß—Ç–æ–±—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å UAF-–∑–∞–ø–∏—Å—å –≤ –æ–±—ä–µ–∫—Ç `msg_msg`, –º–Ω–µ –Ω—É–∂–Ω–æ –±—ã–ª–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫—É, —á—Ç–æ–±—ã —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å `msg_msg` –Ω–∞ –º–µ—Å—Ç–µ `virtio_vsock_sock`. –í Ubuntu Server 24.04 –æ–±—ä–µ–∫—Ç—ã `virtio_vsock_sock` —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º –∏–∑ 16 —Å–ª—ç–±-–∫—ç—à–µ–π `kmalloc-rnd-?-96`, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –±–ª–∞–≥–æ–¥–∞—Ä—è `CONFIG_RANDOM_KMALLOC_CACHES=y`. –í —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å –æ–±—ä–µ–∫—Ç—ã `msg_msg` –∂–∏–≤—É—Ç –≤ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º —Å–ª—ç–±-–∫—ç—à–µ `msg_msg-96`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ –±–ª–∞–≥–æ–¥–∞—Ä—è `CONFIG_SLAB_BUCKETS=y`.

–ß—Ç–æ–±—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫—É, –º–Ω–µ –Ω—É–∂–Ω–æ –±—ã–ª–æ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ —Ç–∞–∫–∏–µ –∞—Ç–∞–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º —è–¥—Ä–µ –≤ Ubuntu Server. –ù–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≥–∏–ø–æ—Ç–µ–∑—ã –∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —ç—Ç–∏–º –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≥–æ–Ω–∫–∏ –±—ã–ª–æ –Ω–∞—Å—Ç–æ—è—â–∏–º –º—É—á–µ–Ω–∏–µ–º. –¢–æ–≥–¥–∞ –ø—Ä–∏—à–ª–∞ –∏–¥–µ—è:

> –ï—Å–ª–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å –º–µ—à–∞–µ—Ç —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–º, —Ç–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–æ–ª–∏–≥–æ–Ω –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω—É–∂–Ω—ã—Ö —ç–∫—Å–ø–ª–æ–π—Ç-–ø—Ä–∏–º–∏—Ç–∏–≤–æ–≤!

## Kernel Hack Drill

–ï—â–µ –≤ 2017 –≥–æ–¥—É —è —Å–æ–∑–¥–∞–ª –¥–ª—è —Å–≤–æ–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º [kernel-hack-drill](https://github.com/a13xp0p0v/kernel-hack-drill). –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ä–µ–¥–∞ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ —Å —ç–∫—Å–ø–ª–æ–π—Ç–∞–º–∏ –¥–ª—è —è–¥—Ä–∞ Linux. –Ø –≤—Å–ø–æ–º–Ω–∏–ª –ø—Ä–æ —ç—Ç–æ—Ç —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç –∏ —Ä–µ—à–∏–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —ç–∫—Å–ø–ª–æ–π—Ç-–ø—Ä–∏–º–∏—Ç–∏–≤–æ–≤ –¥–ª—è CVE-2024-50264.

`kernel-hack-drill` ‚Äî –æ—Ç–∫—Ä—ã—Ç—ã–π –ø—Ä–æ–µ–∫—Ç, —è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª –µ–≥–æ –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π `GPL-3.0`. –í –µ–≥–æ —Å–æ—Å—Ç–∞–≤–µ:
- `drill_mod.c` ‚Äî –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –Ω–µ–±–æ–ª—å—à–æ–≥–æ –º–æ–¥—É–ª—è —è–¥—Ä–∞ Linux, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Å—Ç–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ —á–µ—Ä–µ–∑ —Ñ–∞–π–ª `/proc/drill_act`. –≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –º–æ–∂–Ω–æ —É–¥–æ–±–Ω–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å.
- `drill.h` ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–π —Ñ–∞–π–ª, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–æ–¥—É–ª—è `drill_mod.ko`:
  ```c
  enum drill_act_t {
  	DRILL_ACT_NONE = 0,
  	DRILL_ACT_ALLOC = 1,
  	DRILL_ACT_CALLBACK = 2,
  	DRILL_ACT_SAVE_VAL = 3,
  	DRILL_ACT_FREE = 4,
  	DRILL_ACT_RESET = 5
  };
  
  #define DRILL_ITEM_SIZE 95
  
  struct drill_item_t {
  	unsigned long foobar;
  	void (*callback)(void);
  	char data[]; /* C99 flexible array */
  };
  
  #define DRILL_N 10240
  ```
- `drill_test.c` ‚Äî —Ç–µ—Å—Ç –¥–ª—è `drill_mod.ko` —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `/proc/drill_act`, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞. –≠—Ç–æ—Ç —Ç–µ—Å—Ç –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å `drill_mod.ko` –±–µ–∑ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è —è–¥–µ—Ä–Ω–æ–π –ø–∞–º—è—Ç–∏ –∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –≤ —Ç–æ–º —á–∏—Å–ª–µ –ø—Ä–∏ `CONFIG_KASAN=y`.
- `README.md` ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é `kernel-hack-drill` (—Å–ø–∞—Å–∏–±–æ –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∏ –≤ –µ–≥–æ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏).

–ó–∞–±–∞–≤–Ω—ã–π —Ñ–∞–∫—Ç: –∫–æ–≥–¥–∞ —è –ø—Ä–∏–¥—É–º–∞–ª –Ω–∞–∑–≤–∞–Ω–∏–µ `kernel-hack-drill` –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, —è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å–ª–æ–≤–æ **drill** –≤ –∑–Ω–∞—á–µ–Ω–∏–∏ ¬´—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞¬ª, —Ç–æ –µ—Å—Ç—å –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤—ã–∫–æ–≤ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —è–¥—Ä–∞ Linux. –ù–æ –º–æ–∏ –¥—Ä—É–∑—å—è –∏ —Å—Ç—É–¥–µ–Ω—Ç—ã –ø–æ–Ω—è–ª–∏ –∏–Ω–∞—á–µ. –û–Ω–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∏ —Å–µ–±–µ –Ω–µ—á—Ç–æ —Ç–∞–∫–æ–µ:

<center><img src="/img/drill_tux.jpg" width="60%"></center><br>

–ü—Ä–æ–µ–∫—Ç `kernel-hack-drill` –Ω–µ–º–Ω–æ–≥–æ –ø–æ—Ö–æ–∂ –Ω–∞ [KRWX](https://github.com/hacktivesec/KRWX), –Ω–æ –≥–æ—Ä–∞–∑–¥–æ –ø—Ä–æ—â–µ. –ö—Ä–æ–º–µ —Ç–æ–≥–æ, –æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç —Ü–µ–ª—ã–π –Ω–∞–±–æ—Ä –≥–æ—Ç–æ–≤—ã—Ö PoC-—ç–∫—Å–ø–ª–æ–π—Ç–æ–≤ –¥–ª—è —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ `drill_mod.ko`:
- `drill_uaf_callback.c` ‚Äî UAF-—ç–∫—Å–ø–ª–æ–π—Ç, –≤—ã–∑—ã–≤–∞—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏—é `callback` –∏–∑ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `drill_item_t`. –û–Ω –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Ç–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ —è–¥—Ä–µ –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π.
- `drill_uaf_w_msg_msg.c` ‚Äî UAF-—ç–∫—Å–ø–ª–æ–π—Ç, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π –∑–∞–ø–∏—Å—å –≤ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `drill_item_t`. –û–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫—É –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `msg_msg.m_ts`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —á–∏—Ç–∞—Ç—å –ø–∞–º—è—Ç—å —è–¥—Ä–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü–µ–π –±—É—Ñ–µ—Ä–∞. –Ø –Ω–∞–ø–∏—Å–∞–ª —ç—Ç–æ—Ç PoC-—ç–∫—Å–ø–ª–æ–π—Ç –≤–æ –≤—Ä–µ–º—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –æ–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –≤ –¥–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç—å–µ.
- `drill_uaf_w_pipe_buffer.c` ‚Äî UAF-—ç–∫—Å–ø–ª–æ–π—Ç, —Ç–∞–∫–∂–µ –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π –∑–∞–ø–∏—Å—å –≤ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `drill_item_t`. –û–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫—É –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `pipe_buffer.flags`, —á—Ç–æ–±—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏–∫—É Dirty Pipe –∏ –¥–æ–±–∏—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π. –≠—Ç–æ—Ç PoC-—ç–∫—Å–ø–ª–æ–π—Ç —Ç–æ–∂–µ –±—ã–ª —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –≤–æ –≤—Ä–µ–º—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ —Å CVE-2024-50264.

–ù–µ–¥–∞–≤–Ω–æ –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä—ã –¥–æ–±–∞–≤–∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:
- `drill_uaf_callback_rop_smep.c` ‚Äî –¥–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è `drill_uaf_callback.c` —Å ROP-—Ü–µ–ø–æ—á–∫–æ–π –¥–ª—è –æ–±—Ö–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞—â–∏—Ç—ã SMEP –Ω–∞ `x86_64`.
- `drill_uaf_w_pte.c` ‚Äî UAF-—ç–∫—Å–ø–ª–æ–π—Ç, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π –∑–∞–ø–∏—Å—å –≤ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `drill_item_t`. –û–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫—Ä–æ—Å—Å-–∞–ª–ª–æ–∫–∞—Ç–æ—Ä–Ω—É—é –∞—Ç–∞–∫—É –∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ —Å—Ç—Ä–∞–Ω–∏—Ü (PTE), —á—Ç–æ–±—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏–∫—É Dirty Page Table –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –Ω–∞ `x86_64`.
- `drill_uaf_w_pud.c` ‚Äî —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è `drill_uaf_w_pte.c`, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–µ PTE, –∞ –∑–∞–ø–∏—Å—å –≤ Page Directory Pointer Table (PDPT), –∫–æ—Ç–æ—Ä–∞—è –≤ —è–¥—Ä–µ Linux –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è Page Upper Directory (PUD). –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞—Ç–∞–∫—É Dirty Page Table —á–µ—Ä–µ–∑ –±–æ–ª—å—à–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (huge pages).

–í —Ç–æ—Ç –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —è —Å–Ω–æ–≤–∞ –≤–∑—è–ª—Å—è –∑–∞ `kernel-hack-drill` –ø—Ä–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏ CVE-2024-50264, –ø—Ä–æ–µ–∫—Ç —É–∂–µ –º–Ω–æ–≥–æ –ª–µ—Ç –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è. –ù–æ —Ç–µ–ø–µ—Ä—å `kernel-hack-drill` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ö–æ—Ä–æ—à–∏–π –Ω–∞–±–æ—Ä –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —è–¥—Ä–∞ Linux.

## –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∞–º–∏ –ø—Ä–∏ –ø–æ–º–æ—â–∏ kernel-hack-drill

–ú–Ω–µ –ø—Ä–µ–¥—Å—Ç–æ—è–ª–æ –∏–∑—É—á–∏—Ç—å –Ω—é–∞–Ω—Å—ã –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫ –Ω–∞ HWE-–≤–µ—Ä—Å–∏–∏ —è–¥—Ä–∞ Ubuntu Server —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ –∑–∞—â–∏—Ç—ã —Å–ª—ç–±-–∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞.

–Ø —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫—É –≤ `drill_uaf_w_msg_msg.c`. [–ü–æ–ª–Ω—ã–π –∫–æ–¥ –µ—Å—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏](https://github.com/a13xp0p0v/kernel-hack-drill/blob/e3a105cde99912c89c2c1470a29101eb0d9c2d56/drill_uaf_w_msg_msg.c), –∑–¥–µ—Å—å —è –æ–ø–∏—à—É –æ–±—â–∏–π –ø–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π. –ß—Ç–æ–±—ã –≤–Ω–∏–∫–Ω—É—Ç—å –≤ —Ç–µ–º—É, —Å–æ–≤–µ—Ç—É—é –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ–∫–ª–∞–¥ [–ê–Ω–¥—Ä–µ—è –ö–æ–Ω–æ–≤–∞–ª–æ–≤–∞](https://xairy.io/about) ¬´[SLUB Internals for Exploit Developers](https://www.youtube.com/watch?v=2hYzxsWeNcE)¬ª.

–ü—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –∞—Ç–∞–∫–∏ –Ω—É–∂–Ω–æ –±—ã–ª–æ —Å–æ–±—Ä–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ `/sys/kernel/slab`. –°—Ç—Ä—É–∫—Ç—É—Ä—ã `virtio_vsock_sock` (80 –±–∞–π—Ç) –∏ `drill_item_t` (95 –±–∞–π—Ç) —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Å–ª—ç–±-–∫—ç—à–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç:
 - –ø–æ 42 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ (chunks) –≤ –∫–∞–∂–¥–æ–º —Å–ª—ç–±–µ (`objs_per_slab=42`),
 - –ø–æ 120 —á–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å–ª—ç–±–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —è–¥—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ (`cpu_partial=120`).

–ê–ª–≥–æ—Ä–∏—Ç–º –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∏:
1. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å–ª—ç–±, –≤—ã–¥–µ–ª–∏–≤ `objs_per_slab` –æ–±—ä–µ–∫—Ç–æ–≤. –ê–∫—Ç–∏–≤–Ω—ã–º –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–ª—ç–±, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —è–¥—Ä–æ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∞–ª–ª–æ–∫–∞—Ü–∏–∏.
2. –í—ã–¥–µ–ª—è–µ–º `objs_per_slab * cpu_partial` –æ–±—ä–µ–∫—Ç–æ–≤, —á—Ç–æ–±—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å `cpu_partial` –ø–æ–ª–Ω—ã—Ö —Å–ª—ç–±–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–∂–µ –ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ partial list –Ω–∞ —à–∞–≥–µ 6.
3. –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ª—ç–±, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π UAF-–æ–±—ä–µ–∫—Ç. –î–ª—è —ç—Ç–æ–≥–æ –≤—ã–¥–µ–ª—è–µ–º `objs_per_slab` –æ–±—ä–µ–∫—Ç–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∏—Å—è—á—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —É—è–∑–≤–∏–º—ã–π –æ–±—ä–µ–∫—Ç –≤ —ç—Ç–æ–º —Å–ª—ç–±–µ.
4. –°–Ω–æ–≤–∞ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å–ª—ç–±, –≤—ã–¥–µ–ª–∏–≤ `objs_per_slab` –æ–±—ä–µ–∫—Ç–æ–≤. –≠—Ç–æ—Ç —à–∞–≥ **–æ—á–µ–Ω—å –≤–∞–∂–µ–Ω** –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∏. –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ —Å–ª—ç–± —Å —É—è–∑–≤–∏–º—ã–º –æ–±—ä–µ–∫—Ç–æ–º –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º –∏ –Ω–µ —Å–º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä (page allocator).
5. –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Å–ª—ç–±, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è UAF-–æ–±—ä–µ–∫—Ç. –î–ª—è —ç—Ç–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º `(objs_per_slab * 2 - 1)` –æ–±—ä–µ–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤—ã–¥–µ–ª–µ–Ω—ã –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–¥ —Å–∞–º—ã–º –ø–æ—Å–ª–µ–¥–Ω–∏–º. –¢–µ–ø–µ—Ä—å –∞–∫—Ç–∏–≤–Ω—ã–π —Å–ª—ç–± —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–ª–ª–æ—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç, –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—ã–π —Å–ª—ç–± —Å UAF-–æ–±—ä–µ–∫—Ç–æ–º —É—Ö–æ–¥–∏—Ç –≤ partial list.
6. –ó–∞–ø–æ–ª–Ω—è–µ–º partial list: –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ –æ–¥–Ω–æ–º—É –∏–∑ `objs_per_slab` –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —Å–ª—ç–±–∞—Ö, –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ —à–∞–≥–µ 2. –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ª—ç–±-–∞–ª–ª–æ–∫–∞—Ç–æ—Ä –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –æ—á–∏—Å—Ç–∫—É —Å–ø–∏—Å–∫–∞ —á–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å–ª—ç–±–æ–≤ (partial list) –∏ –ø–µ—Ä–µ–¥–∞—Ç—å –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—ã–π —Å–ª—ç–± —Å UAF-–æ–±—ä–µ–∫—Ç–æ–º –≤ —Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä.
7. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å UAF-–æ–±—ä–µ–∫—Ç–æ–º –≤ –¥—Ä—É–≥–æ–º —Å–ª—ç–±-–∫—ç—à–µ: –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ü–µ–ª–µ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ `msg_msg` (–¥—Ä—É–≥–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, —Ä–∞—Å–ø—ã–ª—è–µ–º –∏—Ö, –≤—ã–ø–æ–ª–Ω—è–µ–º heap spraying). –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –æ–¥–∏–Ω `msg_msg` –æ–∫–∞–∂–µ—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ, –≥–¥–µ —Ä–∞–Ω—å—à–µ –Ω–∞—Ö–æ–¥–∏–ª—Å—è —É—è–∑–≤–∏–º—ã–π –æ–±—ä–µ–∫—Ç (`drill_item_t` –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ).
8. –î–∞–ª—å—à–µ ‚Äî —ç–∫—Å–ø–ª—É–∞—Ç–∏—Ä—É–µ–º UAF! –ù–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑—É—è –≤–∏—Å—è—á—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —É—è–∑–≤–∏–º—ã–π –æ–±—ä–µ–∫—Ç, –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º `msg_msg.m_ts` –∏ –ø–æ–ª—É—á–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —á–∏—Ç–∞—Ç—å –ø–∞–º—è—Ç—å —è–¥—Ä–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –±—É—Ñ–µ—Ä–∞.

–Ø –≤–∏–¥–µ–ª –Ω–µ–º–∞–ª–æ —Å—Ç–∞—Ç–µ–π –ø—Ä–æ –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∏, –Ω–æ –Ω–∏ –æ–¥–Ω–∞ –∏–∑ –Ω–∏—Ö –Ω–µ –æ–±—ä—è—Å–Ω—è–µ—Ç, –∫–∞–∫ —Ç–∞–∫–∏–µ –∞—Ç–∞–∫–∏ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å. –ó–∞–ø–æ–ª–Ω—é —ç—Ç–æ—Ç –ø—Ä–æ–±–µ–ª.

–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º—Å—è –Ω–∞ [–ø—Ä–∏–º–µ—Ä–µ](https://github.com/a13xp0p0v/kernel-hack-drill/blob/e3a105cde99912c89c2c1470a29101eb0d9c2d56/drill_uaf_w_msg_msg.c) –∏–∑ `drill_uaf_w_msg_msg.c`. –ß—Ç–æ–±—ã –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ —Ö–æ–¥–æ–º –∞—Ç–∞–∫–∏ –∏ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –µ–µ, –≤–Ω–æ—Å–∏–º —Å–ª–µ–¥—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —è–¥—Ä–∞:
```diff
diff --git a/mm/slub.c b/mm/slub.c
index be8b09e09d30..e45f055276d1 100644
--- a/mm/slub.c
+++ b/mm/slub.c
@@ -3180,6 +3180,7 @@ static void __put_partials(struct kmem_cache *s, struct slab *partial_slab)
        while (slab_to_discard) {
                slab = slab_to_discard;
                slab_to_discard = slab_to_discard->next;
+               printk("__put_partials: cache 0x%lx slab 0x%lx\n", (unsigned long)s, (unsigned long)slab);
 
                stat(s, DEACTIVATE_EMPTY);
                discard_slab(s, slab);

diff --git a/ipc/msgutil.c b/ipc/msgutil.c
index c7be0c792647..21af92f531d6 100644
--- a/ipc/msgutil.c
+++ b/ipc/msgutil.c
@@ -64,6 +64,7 @@ static struct msg_msg *alloc_msg(size_t len)
        msg = kmem_buckets_alloc(msg_buckets, sizeof(*msg) + alen, GFP_KERNEL);
        if (msg == NULL)
                return NULL;
+       printk("msg_msg 0x%lx\n", (unsigned long)msg);
 
        msg->next = NULL;
        msg->security = NULL;
```

–ó–¥–µ—Å—å –≤ `__put_partials()` –º—ã –≤—ã–≤–æ–¥–∏–º –∞–¥—Ä–µ—Å —Å–ª—ç–±–∞, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ `discard_slab()`. –í `alloc_msg()` –º—ã –≤—ã–≤–æ–¥–∏–º –∞–¥—Ä–µ—Å, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É —è–¥—Ä–æ —Å–æ–∑–¥–∞–ª–æ –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç `msg_msg`.

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–µ —Å–ª—ç–±, —Å–æ–¥–µ—Ä–∂–∞–≤—à–∏–π –æ–±—ä–µ–∫—Ç—ã `drill_item_t`, –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ —Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–º—É –∞–ª–ª–æ–∫–∞—Ç–æ—Ä—É –∏ –∑–∞—Ç–µ–º –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ `msg_msg`. –ú—ã –º–æ–∂–µ–º –ø—Ä–æ–Ω–∞–±–ª—é–¥–∞—Ç—å —ç—Ç–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ PoC-—ç–∫—Å–ø–ª–æ–π—Ç–∞ `drill_uaf_w_msg_msg`:
- –í –∂—É—Ä–Ω–∞–ª–µ —è–¥—Ä–∞:
  ```
  [   32.719582] drill: kmalloc'ed item 5123 (0xffff88800c960660, size 95)
  ```
- –ó–∞—Ç–µ–º –≤ stdout:
  ```
  [+] done, current_n: 5124 (next for allocating)
  [!] obtain dangling reference from use-after-free bug
  [+] done, uaf_n: 5123
  ```
- –ó–∞—Ç–µ–º –≤ GDB (–∏—Å–ø–æ–ª—å–∑—É—è [bata24/gef](https://github.com/bata24/gef)):
  ```
  gef> slab-contains 0xffff88800c960660
  [+] Wait for memory scan
  slab: 0xffffea0000325800
  kmem_cache: 0xffff888003c45300
  base: 0xffff88800c960000
  name: kmalloc-rnd-05-96  size: 0x60  num_pages: 0x1
  ```
- –ù–∞–∫–æ–Ω–µ—Ü, —Å–Ω–æ–≤–∞ –≤ –∂—É—Ä–Ω–∞–ª–µ —è–¥—Ä–∞:
  ```
  [   36.778165] drill: free item 5123 (0xffff88800c960660)
  ...
  [   36.807956] __put_partials: cache 0xffff888003c45300 slab 0xffffea0000325800
  ...
  [   36.892053] msg_msg 0xffff88800c960660
  ```

–ó–¥–µ—Å—å –º—ã –≤–∏–¥–∏–º, –∫–∞–∫ –æ–±—ä–µ–∫—Ç `drill_item_t` –ø–æ –∞–¥—Ä–µ—Å—É `0xffff88800c960660`, –Ω–∞—Ö–æ–¥–∏–≤—à–∏–π—Å—è –≤ —Å–ª—ç–±–µ `0xffffea0000325800`, –±—ã–ª –∑–∞–Ω–æ–≤–æ –≤—ã–¥–µ–ª–µ–Ω —É–∂–µ –∫–∞–∫ `msg_msg`. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞.

–í —Ö–æ–¥–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ —Å `kernel-hack-drill` –Ω–∞ Ubuntu Server 24.04 —è –æ–±–Ω–∞—Ä—É–∂–∏–ª, —á—Ç–æ `CONFIG_RANDOM_KMALLOC_CACHES` –∏ `CONFIG_SLAB_BUCKETS` –±–ª–æ–∫–∏—Ä—É—é—Ç –Ω–∞–∏–≤–Ω—É—é —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é UAF, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º –¥–µ–ª–∞—é—Ç –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ç–∞–±–∏–ª—å–Ω—ã–º–∏. –ü–æ—Ö–æ–∂–µ, –∫–∞—Ä—Ç–∏–Ω–∞ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Ç–∞–∫–∞—è:

<center><img src="/img/slab_hardening-ru.jpg" width="60%"></center><br>

–ü–æ–ª—É—á–∞–µ—Ç—Å—è, —á—Ç–æ –±–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º–∞ [SLAB_VIRTUAL](https://lore.kernel.org/all/20230915105933.495735-15-matteorizzo@google.com/) –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞—â–∏—Ç—ã —è–¥—Ä–æ Linux –æ—Å—Ç–∞–µ—Ç—Å—è —É—è–∑–≤–∏–º—ã–º –¥–ª—è –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫.

## –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∏ –¥–ª—è CVE-2024-50264

–ö–∞–∫ —É–∂–µ —É–ø–æ–º–∏–Ω–∞–ª–æ—Å—å –≤ —Å–ø–∏—Å–∫–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, —É—è–∑–≤–∏–º—ã–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –æ–±—ä–µ–∫—Ç `virtio_vsock_sock` —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Å–µ—Ä–≤–µ—Ä–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º (**–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ‚Ññ 1**). –í—ã–¥–µ–ª–µ–Ω–∏–µ –∏—Ö –≤ –æ–¥–Ω–æ–º —Å–ª—ç–±–µ –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫—É (cross-cache attack), —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –º–µ—à–∞–µ—Ç –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Å–ª—ç–± –ø–æ–ª–Ω–æ—Å—Ç—å—é. –ü–æ–ª—É—á–∞–µ—Ç—Å—è –±–µ–∑–≤—ã—Ö–æ–¥–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:
- –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π vsock –æ—Ç–∫—Ä—ã—Ç—ã–º, —Ç–æ —Å–ª—ç–± —Å UAF-–æ–±—ä–µ–∫—Ç–æ–º –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏ –ø–æ—Ç–æ–º—É –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ —Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä. –ö—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∞ —Å—Ä—ã–≤–∞–µ—Ç—Å—è.
- –ï—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π vsock, —Ç–æ –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è —É—è–∑–≤–∏–º–æ—Å—Ç—å –∏ UAF –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.

–ß—Ç–æ —Å —ç—Ç–∏–º –¥–µ–ª–∞—Ç—å? @v4bel –∏ @qwerty –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Ç–µ—Ö–Ω–∏–∫—É [SLUBStick](https://github.com/IAIK/SLUBStick), —á—Ç–æ–±—ã —Å –ø–æ–º–æ—â—å—é —É—Ç–µ—á–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –ø–æ–±–æ—á–Ω—ã–π –∫–∞–Ω–∞–ª –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–æ–≥–¥–∞ –∞–ª–ª–æ–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å–ª—ç–±. –Ø –ø–æ—à–µ–ª –¥—Ä—É–≥–∏–º –ø—É—Ç–µ–º:
> –ê —á—Ç–æ –µ—Å–ª–∏ **–ø–æ—á—Ç–∏ —Å—Ä–∞–∑—É** –ø—Ä–µ—Ä–≤–∞—Ç—å —Å–∏–≥–Ω–∞–ª–æ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ `connect()`?

–ü–æ —Å—É—Ç–∏, —è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª **–µ—â–µ –æ–¥–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏**, —á—Ç–æ–±—ã –ø—Ä–æ—ç–∫—Å–ø–ª—É–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏ ‚Äî –∏ —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ:
- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ¬´–±–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π¬ª —Å–∏–≥–Ω–∞–ª 33 —á–µ—Ä–µ–∑ 10000 –Ω—Å –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —É—è–∑–≤–∏–º–æ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `connect()`. –≠—Ç–æ –≥–æ—Ä–∞–∑–¥–æ –º–µ–Ω—å—à–µ –∑–∞–¥–µ—Ä–∂–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –Ω—É–∂–Ω–∞ –¥–ª—è UAF.
- –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–ª–æ—Å—å –ª–∏ —Ä–∞–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏:
  1. –°–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ `connect()` –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç ¬´Interrupted system call¬ª.
  2. –î—Ä—É–≥–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π vsock –¥–æ–ª–∂–µ–Ω –±–µ–∑ –ø—Ä–æ–±–ª–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º—É vsock.

–ï—Å–ª–∏ –æ–±–∞ —ç—Ç–∏ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–∏–ª–∏—Å—å, —Ç–æ –º–æ–∂–Ω–æ –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω–Ω—ã–º, —á—Ç–æ —è–¥—Ä–æ —Å–æ–∑–¥–∞–ª–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π `virtio_vsock_sock`. –Ø –æ–±–Ω–∞—Ä—É–∂–∏–ª, —á—Ç–æ –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –ø—Ä–µ—Ä—ã–≤–∞—é—â–∏–π —Å–∏–≥–Ω–∞–ª –ø—Ä–∏—Ö–æ–¥–∏—Ç –µ—â–µ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –º–µ–∂–¥—É –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ —Å–æ–∫–µ—Ç–∞–º–∏, –∏ —è–¥—Ä–æ –µ—â–µ –Ω–µ —É—Å–ø–µ–ª–æ —Å–æ–∑–¥–∞—Ç—å –≤—Ç–æ—Ä–æ–π –æ–±—ä–µ–∫—Ç `virtio_vsock_sock` –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ vsock. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ —Å–Ω–æ–≤–∞ –≤—ã–∑–≤–∞—Ç—å `connect()` –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∏–≥–Ω–∞–ª 33 –ø–æ—Å–ª–µ –æ–±—ã—á–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã —Ç–µ–ø–µ—Ä—å —Å–ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å UAF. –¢–∞–∫–æ–π —Ç—Ä—é–∫ –ø–æ–∑–≤–æ–ª–∏–ª –º–Ω–µ –æ–±–æ–π—Ç–∏ **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ‚Ññ 1** (–ø–∞—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤), –∏ –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∞ –Ω–∞ `virtio_vsock_sock` —Å—Ç–∞–ª–∞ –≤–æ–∑–º–æ–∂–Ω–æ–π.

–ü–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç–∏—á—å —ç—Ç–æ–≥–æ —Ä–∞–Ω–Ω–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥–æ–Ω–∫–∏ –¥–æ–≤–æ–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —Ü–∏–∫–ª–µ. –ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ —É–≤–µ–Ω—á–∞–ª–∏—Å—å —É—Å–ø–µ—Ö–æ–º, –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏, –ø—Ä–∏–≤–æ–¥—è—â–µ–µ –∫ UAF, —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–º–Ω–æ–≥–æ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ: –º–æ–π –ø—Ä–æ—Ç–æ—Ç–∏–ø —ç–∫—Å–ø–ª–æ–π—Ç–∞ –ø–æ–ª—É—á–∏–ª –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω—è—Ç—å UAF –ø—Ä–∏–º–µ—Ä–Ω–æ —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–∞ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç. –≠—Ç–æ —Ä–µ—à–∏–ª–æ –ø—Ä–æ–±–ª–µ–º—É –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏–∑ **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è ‚Ññ 2**. –¢–∞–∫–æ–π ¬´—Å–ø–∏–¥—Ä–∞–Ω¬ª –¥–ª—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —Ç–∞–∫–∂–µ —Å–º—è–≥—á–∏–ª **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ‚Ññ 5**: —Ç–µ–ø–µ—Ä—å —è –º–æ–≥ —Å–¥–µ–ª–∞—Ç—å –æ–∫–æ–ª–æ –ø—è—Ç–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–µ–π —á–µ—Ä–µ–∑ UAF, –ø—Ä–µ–∂–¥–µ —á–µ–º kworker –ø–∞–¥–∞–ª —Å null-ptr-deref –ø–æ—Å–ª–µ –≤–æ—Å—å–º–∏ —Å–µ–∫—É–Ω–¥ (`VSOCK_CLOSE_TIMEOUT`).

–ß—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ‚Ññ 4** (null-ptr-deref –≤ kworker —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ UAF), —è –ø—Ä–∏–º–µ–Ω–∏–ª —Ç—Ä–µ—Ç—å–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥—É @v4bel –∏ @qwerty. –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `connect()` —è –≤—ã–∑—ã–≤–∞—é `listen()` –Ω–∞ —É—è–∑–≤–∏–º–æ–º vsock. –ï—Å–ª–∏ `listen()` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–Ω—å—à–µ –ø–æ—Ç–æ–∫–∞ kworker, —Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ vsock –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `TCP_LISTEN`, –∏–∑-–∑–∞ —á–µ–≥–æ kworker –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ –¥—Ä—É–≥–æ–º—É –∫–æ–¥–æ–≤–æ–º—É –ø—É—Ç–∏, –≥–¥–µ —Ä–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏–µ –Ω—É–ª–µ–≤–æ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª—è –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ—Ç —à–∞–≥ ‚Äî —Å–∞–º–∞—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è —á–∞—Å—Ç—å –≤—Å–µ–≥–æ —ç–∫—Å–ø–ª–æ–π—Ç–∞, `listen()` –Ω–µ –≤—Å–µ–≥–¥–∞ –æ–±–≥–æ–Ω—è–µ—Ç kworker. –û—Å—Ç–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏ —Ü–µ–ø–æ—á–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –≥–æ—Ä–∞–∑–¥–æ –Ω–∞–¥–µ–∂–Ω–µ–µ.

–ö —Ç–æ–º—É –º–æ–º–µ–Ω—Ç—É –º–æ–π —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π –¥–ª—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ CVE-2024-50264 –≤—ã–≥–ª—è–¥–µ–ª —Ç–∞–∫:
1. ~~–£—è–∑–≤–∏–º—ã–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –æ–±—ä–µ–∫—Ç `virtio_vsock_sock` —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Å–µ—Ä–≤–µ—Ä–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º. –í—ã–¥–µ–ª–µ–Ω–∏–µ –∏—Ö –≤ –æ–¥–Ω–æ–º —Å–ª—ç–±–µ –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫—É.~~
2. ~~–ù–µ–æ–±—Ö–æ–¥–∏–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –æ—á–µ–Ω—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ.~~
3. **–ó–∞–ø–∏—Å—å –≤ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ kworker —Å–ø—É—Å—Ç—è –≤—Å–µ–≥–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ `kfree()`. –≠—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∏.**
4. ~~–ü–æ—Å–ª–µ UAF-–∑–∞–ø–∏—Å–∏ –≤ kworker –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏–µ –Ω—É–ª–µ–≤–æ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª—è (null-ptr-deref). –≠—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞, –∏–∑-–∑–∞ –∫–æ—Ç–æ—Ä–æ–π —è –ø–æ–Ω–∞—á–∞–ª—É –æ—Ç–ª–æ–∂–∏–ª —ç—Ç–æ—Ç –±–∞–≥.~~
5. ~~–î–∞–∂–µ –µ—Å–ª–∏ —É–¥–∞–µ—Ç—Å—è –∏–∑–±–µ–∂–∞—Ç—å —ç—Ç–æ–≥–æ –æ—Ç–∫–∞–∑–∞ —è–¥—Ä–∞, —á–µ—Ä–µ–∑ `VSOCK_CLOSE_TIMEOUT` (–≤–æ—Å–µ–º—å —Å–µ–∫—É–Ω–¥) –≤ kworker –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –µ—â–µ –æ–¥–Ω–æ —Ä–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏–µ –Ω—É–ª–µ–≤–æ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª—è.~~
6. **–ü—Ä–∏ —ç—Ç–æ–º kworker –∑–∞–≤–∏—Å–∞–µ—Ç –≤ `spin_lock_bh()`, –µ—Å–ª–∏ –ø–æ–ª–µ `virtio_vsock_sock.tx_lock` –Ω–µ–Ω—É–ª–µ–≤–æ–µ.**

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —Å –ø–æ–º–æ—â—å—é —Ç—Ä—é–∫–æ–≤ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –≥–æ–Ω–∫–∏ —è —Å–ø—Ä–∞–≤–∏–ª—Å—è —Å–æ –≤—Å–µ–º–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏, –∫—Ä–æ–º–µ –¥–≤—É—Ö.

## –°–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ! –ö—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∞ –∑–∞–ø–∞–∑–¥—ã–≤–∞–µ—Ç –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫—É

–ö–∞–∫ –æ—Ç–º–µ—á–µ–Ω–æ –≤ **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–∏ ‚Ññ 3**, UAF-–∑–∞–ø–∏—Å—å –≤ –ø–æ—Ç–æ–∫–µ kworker –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤—Å–µ–≥–æ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ `kfree()` –¥–ª—è `virtio_vsock_sock`. –ê –¥–ª—è –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≥–æ—Ä–∞–∑–¥–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, –ø–æ—ç—Ç–æ–º—É UAF-–∑–∞–ø–∏—Å—å –ø—Ä–æ—Å—Ç–æ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç `virtio_vsock_sock`, –∫–æ—Ç–æ—Ä—ã–π –µ—â–µ –Ω–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª—Å—è –≤ `msg_msg`.

–Ø –Ω–µ –∑–Ω–∞–ª, –∫–∞–∫ —É—Å–∫–æ—Ä–∏—Ç—å —Å–∞–º—É –∫—Ä–æ—Å—Å-–∫—ç—à-–ø—Ä–æ—Ü–µ–¥—É—Ä—É, –∑–∞—Ç–æ —è –∑–Ω–∞–ª, –∫–∞–∫ –º–æ–∂–Ω–æ –∑–∞–º–µ–¥–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞–∫–æ–≥–æ-–ª–∏–±–æ –∫–æ–¥–∞ –≤ —è–¥—Ä–µ. –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –æ–ø–∏—Å–∞–Ω –≤ —Å—Ç–∞—Ç—å–µ –Ø–Ω–∞ –•–æ—Ä–Ω–∞ (Jann Horn) ¬´[Racing against the clock](https://googleprojectzero.blogspot.com/2022/03/racing-against-clock-hitting-tiny.html)¬ª. –û–Ω –ø–æ–∑–≤–æ–ª–∏–ª –∑–∞—Ç–æ—Ä–º–æ–∑–∏—Ç—å –º–æ–π kworker —Ç–∞–∫, —á—Ç–æ–±—ã –º–µ–¥–ª–µ–Ω–Ω–∞—è –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫–∞ —É—Å–ø–µ–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è.

<center><img src="/img/uaf_and_cross_cache-ru.jpg" width="50%"></center><br>

–°—É—Ç—å –≤ —Ç–æ–º, —á—Ç–æ–±—ã ¬´–æ—Ç–≤–ª–µ—á—å¬ª kworker –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–±—ã—Ç–∏–π –æ—Ç —Ç–∞–π–º–µ—Ä–∞ `timerfd`, –∑–∞ –∫–æ—Ç–æ—Ä—ã–º —Å–ª–µ–¥–∏—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ `epoll`. –ü–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π —Ç–∞–∫–æ–π (–ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–º. –≤ [—Å—Ç–∞—Ç—å–µ –Ø–Ω–∞](https://googleprojectzero.blogspot.com/2022/03/racing-against-clock-hitting-tiny.html)):
1. –í—ã–∑–≤–∞—Ç—å `timerfd_create(CLOCK_MONOTONIC, 0)`.
2. –°–æ–∑–¥–∞—Ç—å 8 –¥–æ—á–µ—Ä–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (forks).
3. –í –∫–∞–∂–¥–æ–º –¥–æ—á–µ—Ä–Ω–µ–º –ø—Ä–æ—Ü–µ—Å—Å–µ 100 —Ä–∞–∑ –≤—ã–∑–≤–∞—Ç—å `dup()` –¥–ª—è `timerfd`.
4. –í –∫–∞–∂–¥–æ–º –¥–æ—á–µ—Ä–Ω–µ–º –ø—Ä–æ—Ü–µ—Å—Å–µ 500 —Ä–∞–∑ –≤—ã–∑–≤–∞—Ç—å `epoll_create()`.
5. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ `epoll` –≤–∫–ª—é—á–∏—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –Ω–∞ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–ø–∏—è—Ö `timerfd` —Å –ø–æ–º–æ—â—å—é `epoll_ctl()`.
6. –í –∫–æ–Ω—Ü–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å `timerfd` —Ç–∞–∫, —á—Ç–æ–±—ã –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ —Å–ª—É—á–∏–ª–æ—Å—å –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ä–∞–±–æ—Ç—ã –ø–æ—Ç–æ–∫–∞ kworker:
 ```c
timerfd_settime(timerfd, TFD_TIMER_CANCEL_ON_SET, &retard_tmo, NULL)
 ```

–¢–∞–∫–æ–π –ø—Ä–∏–µ–º —É–≤–µ–ª–∏—á–∏–ª –æ–∫–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥–æ–Ω–∫–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ 80 —Ä–∞–∑.

–ú–Ω–µ —Ö–æ—Ç–µ–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫—É. –ù–æ —è —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –ª–∏–º–∏—Ç–æ–º, –æ –∫–æ—Ç–æ—Ä–æ–º –Ω–µ –±—ã–ª–æ —Å–∫–∞–∑–∞–Ω–æ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç—å–µ. –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ `/proc/sys/fs/epoll/max_user_watches`, –≤—ã–∑–æ–≤ `epoll_ctl()` –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π. –í `man 7 epoll` —á–∏—Ç–∞–µ–º:
> /proc/sys/fs/epoll/max_user_watches –∑–∞–¥–∞–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–æ –≤—Å–µ—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–∞—Ö epoll –≤ —Å–∏—Å—Ç–µ–º–µ. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ö–∞–∂–¥—ã–π –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª–æ–≤—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –∑–∞–Ω–∏–º–∞–µ—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ 90 –±–∞–π—Ç –≤ 32-–±–∏—Ç–Ω–æ–º —è–¥—Ä–µ –∏ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ 160 –±–∞–π—Ç –≤ 64-–±–∏—Ç–Ω–æ–º —è–¥—Ä–µ. –í –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è max_user_watches —Ä–∞–≤–Ω–æ 1/25 (4%) –¥–æ—Å—Ç—É–ø–Ω–æ–π –ø–∞–º—è—Ç–∏ —è–¥—Ä–∞ (low memory), –ø–æ–¥–µ–ª–µ–Ω–Ω–æ–µ –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞ –≤ –±–∞–π—Ç–∞—Ö.

–ù–∞ Ubuntu Server 24.04 —Å 2 –ì–∏–ë –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ `/proc/sys/fs/epoll/max_user_watches` —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 431838, –∏ —ç—Ç–æ –Ω–µ —Ç–∞–∫ –º–Ω–æ–≥–æ. –ü–æ–ª—É—á–∞–µ—Ç—Å—è, —è –º–æ–≥ –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ 8 –¥–æ—á–µ—Ä–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ √ó 500 —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ `epoll` √ó 100 –∫–æ–ø–∏–π —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤, –∏—Ç–æ–≥–æ 400000 –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–π —á–µ—Ä–µ–∑ `epoll` (`epoll` watches).

–û–¥–Ω–∞–∫–æ, —ç—Ç–æ–≥–æ —Ö–≤–∞—Ç–∏–ª–æ, —á—Ç–æ–±—ã –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ‚Ññ 3**, –∏ –º–Ω–µ –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ä–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è `msg_msg`: UAF –≤ vsock –∏–∑–º–µ–Ω–∏–ª `msg_msg.m_ts` —Å 48 –±–∞–π—Ç –Ω–∞ 8192 (`MSGMAX`). –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —è —Å–º–æ–≥ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —á—Ç–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ —è–¥—Ä–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ `msg_msg`, –∏—Å–ø–æ–ª—å–∑—É—è —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ `msgrcv()`.

## –†–∞–∑–±–∏—Ä–∞–µ–º –¥–æ–±—ã—á—É

–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–π `msg_msg` –ø–æ–∑–≤–æ–ª–∏–ª –º–Ω–µ –ø—Ä–æ—á–∏—Ç–∞—Ç—å 8 –ö–∏–ë –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ —è–¥—Ä–∞. –Ø —Å—Ç–∞–ª —Ä–∞–∑–±–∏—Ä–∞—Ç—å —ç—Ç—É ¬´–¥–æ–±—ã—á—É¬ª –∏ –Ω–∞—à–µ–ª –ø–æ–ª–µ–∑–Ω—É—é —É—Ç–µ—á–∫—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: —è–¥–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å `0xffffffff8233cfa0` [1]. –£—Ç–µ—á–∫–∞ –æ–∫–∞–∑–∞–ª–∞—Å—å —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–ª–∞—Å—å —Å –≤—ã—Å–æ–∫–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –Ω–∞ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ —ç–∫—Å–ø–ª–æ–π—Ç–∞, –ø–æ—ç—Ç–æ–º—É —è —Ä–µ—à–∏–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–µ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π —Å –∫—É—á–µ–π (heap feng shui). –° –ø–æ–º–æ—â—å—é GDB —è –≤—ã—è—Å–Ω–∏–ª, —á—Ç–æ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å ‚Äî —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—é `socket_file_ops()`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –≤ —è–¥–µ—Ä–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ `file`. –≠—Ç–æ –º–µ–Ω—è –æ—á–µ–Ω—å –ø–æ—Ä–∞–¥–æ–≤–∞–ª–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤ `struct file` –Ω–µ–ø–æ–¥–∞–ª–µ–∫—É –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —É–∫–∞–∑–∞—Ç–µ–ª—å `f_cred` [2], –∫–æ—Ç–æ—Ä—ã–π —Ç–∞–∫–∂–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤ —ç–∫—Å–ø–ª–æ–π—Ç–µ.

–í–æ—Ç –∫–∞–∫ —è –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–º—è—Ç–∏, –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–π –∑–∞ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –æ–±—ä–µ–∫—Ç–∞ `msg_msg` –ø–æ –∞–¥—Ä–µ—Å—É `0xffff88800e75d600`:
```
gef> p *((struct file *)(0xffff88800e75d600 + 96*26 + 64))
$61 = {
  f_count = {
    counter = 0x0
  },
  f_lock = {
    {
      rlock = {
        raw_lock = {
          {
            val = {
              counter = 0x0
            },
            {
              locked = 0x0,
              pending = 0x0
            },
            {
              locked_pending = 0x0,
              tail = 0x0
            }
          }
        }
      }
    }
  },
  f_mode = 0x82e0003,
  f_op = 0xffffffff8233cfa0 <socket_file_ops>,    [1]
  f_mapping = 0xffff88800ee66f60,
  private_data = 0xffff88800ee66d80,
  f_inode = 0xffff88800ee66e00,
  f_flags = 0x2,
  f_iocb_flags = 0x0,
  f_cred = 0xffff888003b7ad00,                    [2]
  f_path = {
    mnt = 0xffff8880039cec20,
    dentry = 0xffff888005b30b40
  },
  ...
```

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –º–æ–π PoC-—ç–∫—Å–ø–ª–æ–π—Ç –¥–æ–±—ã–ª —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ `struct cred` ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (credentials) —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞. –î–æ –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –æ—Å—Ç–∞–≤–∞–ª—Å—è –æ–¥–∏–Ω —à–∞–≥ ‚Äî –∑–∞–ø–∏—Å—å —è–¥–µ—Ä–Ω–æ–π –ø–∞–º—è—Ç–∏ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º—É –∞–¥—Ä–µ—Å—É (arbitrary address writing). –û–±–ª–∞–¥–∞—è —ç—Ç–æ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é, —è —Å–º–æ–≥ –±—ã –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ —ç–∫—Å–ø–ª–æ–π—Ç–∞ –∏ —Å—Ç–∞—Ç—å —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º root. –≠—Ç–æ –±—ã–ª–∞ –±—ã –∞—Ç–∞–∫–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –¥–∞–Ω–Ω—ã–µ (data-only attack), –±–µ–∑ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –ø–æ—Ç–æ–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

## –í –ø–æ–∏—Å–∫–∞—Ö –ø—Ä–∏–º–∏—Ç–∏–≤–∞ –∑–∞–ø–∏—Å–∏ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º—É –∞–¥—Ä–µ—Å—É

–° —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –Ω–∞—á–∞–ª–∞—Å—å —Å–∞–º–∞—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –∏ —Å–ª–æ–∂–Ω–∞—è —á–∞—Å—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è. –ú–Ω–µ –Ω—É–∂–µ–Ω –±—ã–ª –æ–±—ä–µ–∫—Ç —è–¥—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å –ø–æ–º–æ—â—å—é –º–æ–µ–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π UAF-–∑–∞–ø–∏—Å–∏ –∏ –ø–æ–ª—É—á–∏—Ç—å –∑–∞ —Å—á–µ—Ç —ç—Ç–æ–≥–æ —ç–∫—Å–ø–ª–æ–π—Ç-–ø—Ä–∏–º–∏—Ç–∏–≤ –∑–∞–ø–∏—Å–∏ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º—É –∞–¥—Ä–µ—Å—É. –ü–æ–∏—Å–∫–∏ –æ–∫–∞–∑–∞–ª–∏—Å—å –∏–∑–Ω—É—Ä–∏—Ç–µ–ª—å–Ω—ã–º–∏. –ß—Ç–æ —è –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª:
- –ò–∑—É—á–∏–ª –¥–µ—Å—è—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —è–¥—Ä–∞ Linux.
- –ü–µ—Ä–µ—á–∏—Ç–∞–ª –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π –ø—Ä–æ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ —è–¥—Ä–µ.
- –ü–æ–ø—Ä–æ–±–æ–≤–∞–ª [Kernel Exploitation Dashboard](https://kernelctf-dash.storage.googleapis.com/processed/v6.1.111/index.html#!heap/*/msg_msg/64..128) –æ—Ç –≠–¥—É–∞—Ä–¥–æ –í–µ–ª–∞ (Eduardo Vela) –∏ –∫–æ–º–∞–Ω–¥—ã KernelCTF.

–û–¥–Ω–∞ –∏–∑ –∏–¥–µ–π –∑–∞–∫–ª—é—á–∞–ª–∞—Å—å –≤ —Ç–æ–º, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–æ—é –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—É—é UAF-–∑–∞–ø–∏—Å—å –¥–ª—è –∞—Ç–∞–∫–∏ Dirty Page Table. –≠—Ç—É —Ç–µ—Ö–Ω–∏–∫—É —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ [—Ö–æ—Ä–æ—à–æ –æ–ø–∏—Å–∞–ª](https://web.archive.org/web/20250226150503/https://yanglingxi1993.github.io/dirty_pagetable/dirty_pagetable.html) –ù–∏–∫–æ–ª–∞—Å –í—É (Nicolas Wu). –ï–µ —Å—É—Ç—å –≤ —Ç–æ–º, —á—Ç–æ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü –ø–æ–∑–≤–æ–ª—è—é—Ç –∞—Ç–∞–∫—É—é—â–µ–º—É —á–∏—Ç–∞—Ç—å –∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –ø–∞–º—è—Ç—å –ø–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º—É —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º—É –∞–¥—Ä–µ—Å—É.

–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ —è –º–æ–≥ –±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫—É (–∞ —Ç–æ—á–Ω–µ–µ, –∫—Ä–æ—Å—Å-–∞–ª–ª–æ–∫–∞—Ç–æ—Ä–Ω—É—é –∞—Ç–∞–∫—É), —á—Ç–æ–±—ã —Å –ø–æ–º–æ—â—å—é UAF-–∑–∞–ø–∏—Å–∏ –≤ –æ–±—ä–µ–∫—Ç `virtio_vsock_sock` –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü. –ù–æ —á—Ç–æ–±—ã –∞—Ç–∞–∫–æ–≤–∞—Ç—å —è–¥–µ—Ä–Ω—ã–π –∫–æ–¥ –∏–ª–∏ –∫—É—á—É, –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å —Ü–µ–ª–µ–≤–æ–π –ø–∞–º—è—Ç–∏. –ù–∞ —É–º –ø—Ä–∏—à–ª–∏ –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:
1. –°–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–±–æ—Ä —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∞–¥—Ä–µ—Å–æ–≤ (bruteforcing). –í –º–æ–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ—Ç —Å–ø–æ—Å–æ–± –Ω–µ –≥–æ–¥–∏–ª—Å—è: –ø—Ä–æ—Ç–æ—Ç–∏–ø —ç–∫—Å–ø–ª–æ–π—Ç–∞ –º–æ–≥ –≤—ã–ø–æ–ª–Ω–∏—Ç—å UAF –ø—Ä–∏–º–µ—Ä–Ω–æ –ø—è—Ç—å —Ä–∞–∑ –¥–æ –æ—Ç–∫–∞–∑–∞ kworker. –≠—Ç–æ–≥–æ –±—ã–ª–æ —è–≤–Ω–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø–µ—Ä–µ–±–æ—Ä–∞.
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Ç–µ—á–∫—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ KASLR-—Å–º–µ—â–µ–Ω–∏–∏, –∫–æ—Ç–æ—Ä—É—é —è –ø–æ–ª—É—á–∏–ª –∑–∞ —Å—á–µ—Ç —á—Ç–µ–Ω–∏—è —è–¥–µ—Ä–Ω–æ–π –ø–∞–º—è—Ç–∏ —Å –ø–æ–º–æ—â—å—é `msg_msg`. –Ø —Ä–µ—à–∏–ª –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç.

–Ø –±—ã—Å—Ç—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏–ª, –∫–∞–∫ –≤–µ–¥–µ—Ç —Å–µ–±—è KASLR –Ω–∞ `X86_64`, –≤–∫–ª—é—á–∏–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `CONFIG_RANDOMIZE_BASE` –∏ `CONFIG_RANDOMIZE_MEMORY`. –ù–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É, —è —Å—Ä–∞–≤–Ω–∏–ª —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –∫–æ–¥–∞ —è–¥—Ä–∞.

–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ VM:
```
gef> ksymaddr-remote
[+] Wait for memory scan
0xffffffff98400000 T _text

gef> v2p 0xffffffff98400000
Virt: 0xffffffff98400000 -> Phys: 0x57400000
```

–í—Ç–æ—Ä–æ–π –∑–∞–ø—É—Å–∫ VM:
```
gef> ksymaddr-remote
[+] Wait for memory scan
0xffffffff81800000 T _text

gef> v2p 0xffffffff81800000
Virt: 0xffffffff81800000 -> Phys: 0x18600000
```

–ó–∞—Ç–µ–º —è –≤—ã—á–∏—Å–ª–∏–ª —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º–∏ –∞–¥—Ä–µ—Å–∞–º–∏:
- –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ VM: `0xffffffff98400000 - 0x57400000 = 0xffffffff41000000`
- –í—Ç–æ—Ä–æ–π –∑–∞–ø—É—Å–∫ VM: `0xffffffff81800000 - 0x18600000 = 0xffffffff69200000`

–ü–æ—Å–∫–æ–ª—å–∫—É `0xffffffff41000000` –Ω–µ —Ä–∞–≤–Ω–æ `0xffffffff69200000`, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ KASLR-—Å–º–µ—â–µ–Ω–∏–∏ –∫–æ–¥–∞ —è–¥—Ä–∞ –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –∞–¥—Ä–µ—Å–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã—á–∏—Å–ª–∏—Ç—å –µ–≥–æ —Å–º–µ—â–µ–Ω–∏–µ –≤ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏.

<center><img src="/img/kaslr.jpg" width="60%"></center><br>

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —á—Ç–æ–±—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞—Ç–∞–∫—É Dirty Page Table, –º–Ω–µ –Ω—É–∂–Ω–æ –±—ã–ª–æ –∫–∞–∫-—Ç–æ –¥–æ–±—ã—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å —è–¥—Ä–∞. –ú–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –ø—Ä–∏–¥—É–º–∞—Ç—å –∫–∞–∫–∏–µ-—Ç–æ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ —Å–æ —Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–º –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–æ–º (page-allocator feng shui) –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º –ø–∞–º—è—Ç–∏ —è–¥—Ä–∞ —á–µ—Ä–µ–∑ `msg_msg`. –ù–æ —Ç–∞–∫–æ–π –ø–æ—Ö–æ–¥ –ø–æ–∫–∞–∑–∞–ª—Å—è —á–µ—Ä–µ—Å—á—É—Ä –∑–∞–ø—É—Ç–∞–Ω–Ω—ã–º, –∞ —Ö–æ—Ç–µ–ª–æ—Å—å –Ω–∞–π—Ç–∏ –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–µ –∏ –∫—Ä–∞—Å–∏–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ.

–Ø –ø—Ä–æ–¥–æ–ª–∂–∏–ª –ø–æ–∏—Å–∫–∏ –æ–±—ä–µ–∫—Ç–∞-–∂–µ—Ä—Ç–≤—ã –¥–ª—è UAF-–∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã–π –æ–±–µ—Å–ø–µ—á–∏–ª –±—ã –∑–∞–ø–∏—Å—å –ø–∞–º—è—Ç–∏ —è–¥—Ä–∞ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º—É –∞–¥—Ä–µ—Å—É, –∏ –≤ –∏—Ç–æ–≥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª —Å–≤–æ–π –≤—ã–±–æ—Ä –Ω–∞ `pipe_buffer`.

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞ (pipe) —Å –ø–æ–º–æ—â—å—é —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `pipe()` —è–¥—Ä–æ –≤—ã–¥–µ–ª—è–µ—Ç –º–∞—Å—Å–∏–≤ —Å—Ç—Ä—É–∫—Ç—É—Ä `pipe_buffer`. –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç `pipe_buffer` –≤ —ç—Ç–æ–º –º–∞—Å—Å–∏–≤–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–∞–º—è—Ç–∏, –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ, –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –≤ –∫–∞–Ω–∞–ª. –ù–∞ —Å—Ö–µ–º–µ –Ω–∏–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞:

<center><img src="/img/pipe_buffer.png" width="50%"></center><br>

–≠—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –æ–∫–∞–∑–∞–ª—Å—è –æ—Ç–ª–∏—á–Ω–æ–π —Ü–µ–ª—å—é –¥–ª—è UAF-–∑–∞–ø–∏—Å–∏. –Ø —Å–º–æ–≥ —Å–æ–∑–¥–∞—Ç—å –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ `pipe_buffer` —Ç–æ–≥–æ –∂–µ —Ä–∞–∑–º–µ—Ä–∞, —á—Ç–æ –∏ `virtio_vsock_sock`, –∏–∑–º–µ–Ω–∏–≤ –µ–º–∫–æ—Å—Ç—å –∫–∞–Ω–∞–ª–∞: `fcntl(pipe_fd[1], F_SETPIPE_SZ, PAGE_SIZE * 2)`. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —ç—Ç–æ–≥–æ –≤—ã–∑–æ–≤–∞ —è–¥—Ä–æ –∏–∑–º–µ–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä –º–∞—Å—Å–∏–≤–∞ –Ω–∞ `2 * sizeof(struct pipe_buffer) = 80 bytes`, —á—Ç–æ –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ä–∞–∑–º–µ—Ä–æ–º `virtio_vsock_sock`.

–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –ø—Ä–∏ UAF-–∑–∞–ø–∏—Å–∏ –≤ `virtio_vsock_sock`, 4 –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã—Ö –±–∞–π—Ç–∞ –ø–æ —Å–º–µ—â–µ–Ω–∏—é 24 –ø–æ–∑–≤–æ–ª—è—é—Ç –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª–µ `pipe_buffer.flags`, –∫–∞–∫ –≤ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–π [–∞—Ç–∞–∫–µ Dirty Pipe](https://dirtypipe.cm4all.com/) –æ—Ç –ú–∞–∫—Å–∞ –ö–µ–ª–ª–µ—Ä–º–∞–Ω–∞ (Max Kellermann).

<center><img src="/img/uaf_write_pipe_buffer0.png" width="90%"></center><br>

–≠—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç Dirty Pipe –≤–æ–æ–±—â–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —É—Ç–µ—á–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –¥–∞–µ—Ç –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –∑–∞ –æ–¥–Ω—É UAF-–∑–∞–ø–∏—Å—å. –í–¥–æ—Ö–Ω–æ–≤–∏–≤—à–∏—Å—å, —è —Ä–µ—à–∏–ª –ø–æ—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å `pipe_buffer` –≤ –º–æ–µ–º `kernel-hack-drill`.

## –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å Dirty Pipe

–Ø —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –∞—Ç–∞–∫—É Dirty Pipe –¥–ª—è —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–æ–π —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ `kernel-hack-drill`. PoC-—ç–∫—Å–ø–ª–æ–π—Ç `drill_uaf_w_pipe_buffer.c` –¥–æ—Å—Ç—É–ø–µ–Ω –≤ [—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏](https://github.com/a13xp0p0v/kernel-hack-drill/blob/e3a105cde99912c89c2c1470a29101eb0d9c2d56/drill_uaf_w_pipe_buffer.c). –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç —ç–∫—Å–ø–ª–æ–π—Ç:
1. –í—ã–ø–æ–ª–Ω—è–µ—Ç –∫—Ä–æ—Å—Å-–∫—ç—à-–∞—Ç–∞–∫—É –∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Å–ª—ç–± —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ `drill_item_t` –≤ —Å–ª—ç–± —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ `pipe_buffer`.
2. –≠–∫—Å–ø–ª—É–∞—Ç–∏—Ä—É–µ—Ç UAF-–∑–∞–ø–∏—Å—å –≤ `drill_item_t`. –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ –∞—Ç–∞–∫—É—é—â–∏–º –±–∞–π—Ç—ã, –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –≤ `drill_item_t` –ø–æ —Å–º–µ—â–µ–Ω–∏—é 24, –º–µ–Ω—è—é—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è `pipe_buffer.flags`.
3. –†–µ–∞–ª–∏–∑—É–µ—Ç –∞—Ç–∞–∫—É Dirty Pipe, –¥–æ–±–∏–≤–∞—è—Å—å –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π ¬´–≤ –æ–¥–∏–Ω –≤—ã—Å—Ç—Ä–µ–ª¬ª –∏ –±–µ–∑ —É—Ç–µ—á–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ ‚Äî –∫—Ä–∞—Å–æ—Ç–∞!

–ß—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ç—É —Ç–µ—Ö–Ω–∏–∫—É –≤ –º–æ–µ–º PoC-—ç–∫—Å–ø–ª–æ–π—Ç–µ –¥–ª—è CVE-2024-50264, –Ω—É–∂–Ω–æ –±—ã–ª–æ –æ–±–æ–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ‚Ññ 6**: –ø–æ—Ç–æ–∫ kworker –∑–∞–≤–∏—Å–∞–ª –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ UAF-–∑–∞–ø–∏—Å—å—é, –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–æ–ª–µ `virtio_vsock_sock.tx_lock` –Ω–µ —Ä–∞–≤–Ω–æ –Ω—É–ª—é. –Ø –Ω–∞—à–µ–ª, –∫–∞–∫ –æ–±–æ–π—Ç–∏ —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É: —Å–¥–µ–ª–∞–ª `splice()` –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ –∫–∞–Ω–∞–ª, –Ω–∞—á–∏–Ω–∞—è —Å –Ω—É–ª–µ–≤–æ–≥–æ —Å–º–µ—â–µ–Ω–∏—è:
```c
	loff_t file_offset = 0;
	ssize_t bytes = 0;

	/* N.B. splice modifies the file_offset value */
	bytes = splice(temp_file_fd, &file_offset, pipe_fd[1], NULL, 1, 0);
	if (bytes < 0)
		err_exit("[-] splice");
	if (bytes != 1)
		err_exit("[-] splice short");
```

–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –ø–æ–ª–µ `pipe_buffer.offset` –æ—Å—Ç–∞–µ—Ç—Å—è –Ω—É–ª–µ–≤—ã–º, –ø–æ—ç—Ç–æ–º—É kworker –Ω–µ –∑–∞–≤–∏—Å–∞–µ—Ç –ø—Ä–∏ –∑–∞—Ö–≤–∞—Ç–µ —Å–ø–∏–Ω–ª–æ–∫–∞:

<center><img src="/img/uaf_write_pipe_buffer2.png" width="90%"></center><br>

–ö–∞–∑–∞–ª–æ—Å—å –±—ã, –≤—Å–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Äî –Ω–æ —Ç—É—Ç —è –∑–∞–º–µ—Ç–∏–ª, —á—Ç–æ UAF-–∑–∞–ø–∏—Å—å –ø–æ–≤—Ä–µ–∂–¥–∞–µ—Ç –µ—â–µ –∏ —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—é `pipe_buffer.ops`, –∑–∞–ø–∏—Å—ã–≤–∞—è –≤ –Ω–µ–≥–æ —á–µ—Ç—ã—Ä–µ –Ω—É–ª–µ–≤—ã—Ö –±–∞–π—Ç–∞ –∏–∑ `peer_fwd_cnt`. –≠—Ç–æ—Ç –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–π –ø–æ–±–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏–≤–æ–¥–∏–ª –∫ –æ—Ç–∫–∞–∑—É —è–¥—Ä–∞ (kernel crash) –ø—Ä–∏ –ª—é–±–æ–π –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç–µ —Å `pipe_buffer` ‚òπÔ∏è.

<center><img src="/img/uaf_write_pipe_buffer3.png" width="90%"></center><br>

–≠—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –º–µ–Ω—è –∫ —Å–ª–µ–¥—É—é—â–µ–π —Ü–µ–ø–æ—á–∫–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π:
1. –ß—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å –∞—Ç–∞–∫—É Dirty Pipe, –Ω—É–∂–µ–Ω –∏—Å–ø—Ä–∞–≤–Ω—ã–π `pipe_buffer` —Å –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—è `ops`.
2. –ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å `0xffffffff` –≤ —Å—Ç–∞—Ä—à–∏—Ö –±–∞–π—Ç–∞—Ö —É–∫–∞–∑–∞—Ç–µ–ª—è `pipe_buffer.ops`, –Ω—É–∂–Ω–æ –∏–º–µ—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ `peer_fwd_cnt`.
3. –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ–Ω—É–ª–µ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è `peer_fwd_cnt` –≤ `virtio_vsock_sock` –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–æ–∫–µ—Ç.
4. –ß—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ vsock, —Å–Ω–∞—á–∞–ª–∞ –Ω—É–∂–µ–Ω —É—Å–ø–µ—à–Ω—ã–π `connect()`.
5. –ù–æ —É—Å–ø–µ—à–Ω—ã–π `connect()` –Ω–∞ —É—è–∑–≤–∏–º–æ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º —Å–æ–∫–µ—Ç–µ –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏ –∏ UAF ‚õî.

–£–≤—ã!

## –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π —Å pipe_buffer

–ò—Ç–∞–∫, –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç Dirty Pipe –Ω–µ –ø–æ–¥–æ—à–µ–ª –¥–ª—è –º–æ–µ–π —É—è–∑–≤–∏–º–æ—Å—Ç–∏. –ù–æ –≤–¥—Ä—É–≥ –º–µ–Ω—è –æ—Å–µ–Ω–∏–ª–æ:
> –ß—Ç–æ –µ—Å–ª–∏ —Å–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª —Å –µ–º–∫–æ—Å—Ç—å—é `PAGE_SIZE * 4`, —á—Ç–æ–±—ã –∑–∞—Å—Ç–∞–≤–∏—Ç—å —è–¥—Ä–æ –≤—ã–¥–µ–ª–∏—Ç—å –º–∞—Å—Å–∏–≤ –∏–∑ —á–µ—Ç—ã—Ä–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ `pipe_buffer` –≤ `kmalloc-192`?

–¢–æ–≥–¥–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–∞–º—è—Ç–∏ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫: —á–µ—Ç—ã—Ä–µ –æ–±—ä–µ–∫—Ç–∞ `pipe_buffer` –≤ –æ–¥–Ω–æ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç–µ –∏–∑ `kmalloc-192` –æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ, –≥–¥–µ —Ä–∞–Ω—å—à–µ –∂–∏–ª–∏ –¥–≤–∞ –æ–±—ä–µ–∫—Ç–∞ `virtio_vsock_sock` –≤ –¥–≤—É—Ö —Å–æ—Å–µ–¥–Ω–∏—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ö –∏–∑ `kmalloc-96`. –≠—Ç–æ –æ—Ç—Ä–∞–∂–µ–Ω–æ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ö–µ–º–µ:

<center><img src="/img/uaf_write_pipe_buffer7.png" width="90%"></center><br>

–ó–¥–µ—Å—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –Ω–∞ –æ–¥–Ω–æ–º –∏–∑ –¥–≤—É—Ö –æ–±—ä–µ–∫—Ç–æ–≤ `virtio_vsock_sock`. –†–∞–∑–±–µ—Ä–µ–º –æ–±–∞ —ç—Ç–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ –æ—á–µ—Ä–µ–¥–∏.

#### –ü—Ä–∏ UAF –Ω–∞ –ø–µ—Ä–≤–æ–º virtio_vsock_sock

–ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∑–∞–≤–∏—Å–∞–Ω–∏—è –∏ –ø–∞–¥–µ–Ω–∏—è —è–¥—Ä–∞, –∫–æ–≥–¥–∞ UAF –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –Ω–∞ **–ø–µ—Ä–≤–æ–º** `virtio_vsock_sock`, —è –ø—Ä–∏–º–µ–Ω–∏–ª –¥–≤–∞ —Ç—Ä—é–∫–∞:
1. –í—ã–ø–æ–ª–Ω–∏–ª `splice()` –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ –∫–∞–Ω–∞–ª —Å –Ω—É–ª–µ–≤—ã–º –Ω–∞—á–∞–ª—å–Ω—ã–º —Å–º–µ—â–µ–Ω–∏–µ–º. –ö–∞–∫ –≥–æ–≤–æ—Ä–∏–ª–æ—Å—å –≤—ã—à–µ, –ø–æ–ª–µ `offset` –ø–µ—Ä–≤–æ–≥–æ `pipe_buffer` –ø—Ä–∏ —ç—Ç–æ–º –æ—Å—Ç–∞–µ—Ç—Å—è –Ω—É–ª–µ–≤—ã–º, –ø–æ—ç—Ç–æ–º—É –ø–æ—Ç–æ–∫ kworker –Ω–µ –∑–∞–≤–∏—Å–∞–µ—Ç –ø—Ä–∏ –∑–∞—Ö–≤–∞—Ç–µ —Å–ø–∏–Ω–ª–æ–∫–∞ –ø–µ—Ä–µ–¥ UAF.
2. –í—ã—á–∏—Ç–∞–ª –∏ —Ç–µ–º —Å–∞–º—ã–º —Å–±—Ä–æ—Å–∏–ª –ø–µ—Ä–≤—ã–π `pipe_buffer` **–¥–æ UAF**, –Ω–µ —Ç—Ä–æ–≥–∞—è –µ–≥–æ –ø–æ–ª–µ `offset`:
    ```c
    /* Remove the first pipe_buffer without changing the `pipe_buffer.offset` */
    bytes = splice(pipe_fd[0], NULL, temp_pipe_fd[1], NULL, 1, 0);
    if (bytes < 0)
    	err_exit("[-] splice");
    if (bytes == 0)
    	err_exit("[-] splice short");

    /*
     * Let's read this byte and empty the first pipe_buffer.
     * So if the UAF writing corrupts the first pipe_buffer,
     * that will not crash the kernel. Cool!
     */
    bytes = read(temp_pipe_fd[0], pipe_data_to_read, 1); /* 1 spliced byte */
    if (bytes < 0)
    	err_exit("[-] pipe read 1");
    if (bytes != 1)
    	err_exit("[-] pipe read 1 short");
    ```
  –ü–æ—Å–ª–µ —Ç–∞–∫–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–∑–æ–≤–æ–≤ `splice()` –∏ `read()` –ø–µ—Ä–≤—ã–π `pipe_buffer` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º. –î–∞–∂–µ –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥—É—é—â–∞—è UAF-–∑–∞–ø–∏—Å—å –ø–æ–≤—Ä–µ–¥–∏—Ç –µ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª—å `ops`, –¥–∞–ª—å–Ω–µ–π—à–∞—è —Ä–∞–±–æ—Ç–∞ —Å –∫–∞–Ω–∞–ª–æ–º –Ω–µ –≤—ã–∑–æ–≤–µ—Ç —Ä–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª—è –≤ —ç—Ç–æ–º `pipe_buffer` –∏ –æ—Ç–∫–∞–∑–∞ —è–¥—Ä–∞ –Ω–µ –±—É–¥–µ—Ç.

#### –ü—Ä–∏ UAF –Ω–∞ –≤—Ç–æ—Ä–æ–º virtio_vsock_sock

–Ø —Ö–æ—Ç–µ–ª –ø—Ä–æ—ç–∫—Å–ø–ª—É–∞—Ç–∏—Ä–æ–≤–∞—Ç—å UAF –Ω–∞ **–≤—Ç–æ—Ä–æ–º** `virtio_vsock_sock`, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —á–µ—Ç–≤–µ—Ä—Ç—ã–π `pipe_buffer`. –ß—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∑–∞–≤–∏—Å–∞–Ω–∏–µ —è–¥—Ä–∞, –∫–æ–≥–¥–∞ UAF –ø–æ–ø–∞–¥–∞–µ—Ç –≤–æ –≤—Ç–æ—Ä–æ–π `virtio_vsock_sock`, —è –µ—â–µ –¥–≤–∞ —Ä–∞–∑–∞ –≤—ã–ø–æ–ª–Ω–∏–ª —Ç–æ—Ç –∂–µ `splice(temp_file_fd, &file_offset, pipe_fd[1], NULL, 1, 0)`. –≠—Ç–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –≤—Ç–æ—Ä–æ–π –∏ —Ç—Ä–µ—Ç–∏–π –æ–±—ä–µ–∫—Ç—ã `pipe_buffer`, –æ—Å—Ç–∞–≤–∏–≤ –∏—Ö –ø–æ–ª—è `flags` —Ä–∞–≤–Ω—ã–º–∏ –Ω—É–ª—é (–¥–∞–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —Å –∫–∞–Ω–∞–ª–æ–º –Ω–µ –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∏ –æ–¥–∏–Ω –∏–∑ –±–∏—Ç–æ–≤ `PIPE_BUF_FLAG_*`). –°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –µ—Å–ª–∏ UAF —Å–ª—É—á–∏—Ç—Å—è –Ω–∞ –≤—Ç–æ—Ä–æ–º `virtio_vsock_sock`, —Ç–æ –ø–æ—Ç–æ–∫ kworker –Ω–µ –∑–∞–≤–∏—Å–∞–µ—Ç –Ω–∞ –≤—ã–∑–æ–≤–µ `spin_lock_bh()` –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `virtio_transport_space_update()`.

–¢–∞–∫–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–∞–Ω–∞–ª–∞ –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–µ–π —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –¥–∞–ª–∞ –º–Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —á–µ—Ç—ã—Ä–µ –º–ª–∞–¥—à–∏—Ö –±–∞–π—Ç–∞ —É–∫–∞–∑–∞—Ç–µ–ª—è `page` –≤ —á–µ—Ç–≤–µ—Ä—Ç–æ–º –æ–±—ä–µ–∫—Ç–µ `pipe_buffer`!

<center><img src="/img/uaf_write_pipe_buffer6.png" width="90%"></center><br>

–ü—Ä–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞—Ö —Å –º–∞—Å—Å–∏–≤–æ–º –æ–±—ä–µ–∫—Ç–æ–≤ `pipe_buffer` –æ—á–µ–Ω—å –ø–æ–º–æ–≥ –º–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª–∏–≥–æ–Ω `kernel-hack-drill`. –ë–µ–∑ –Ω–µ–≥–æ –±—ã–ª–æ –±—ã —á—Ä–µ–∑–≤—ã—á–∞–π–Ω–æ —Ç—Ä—É–¥–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –∏ –æ—Ç–ª–∞–¥–∏—Ç—å —ç–∫—Å–ø–ª–æ–π—Ç-–ø—Ä–∏–º–∏—Ç–∏–≤ —Å –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é `pipe_buffer.page` –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥–æ–Ω–∫–∏ CVE-2024-50264.

# AARW –∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –º–µ—Å—Ç—å KASLR

–í –æ–±—ä–µ–∫—Ç–µ `pipe_buffer` –ø–æ–ª–µ `page` —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–¥—Ä–µ—Å —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ `struct page` –≤–Ω—É—Ç—Ä–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã –ø–∞–º—è—Ç–∏ (`vmemmap`). `vmemmap` ‚Äî —ç—Ç–æ –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç —è–¥—Ä—É —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∞–¥—Ä–µ—Å–æ–≤–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –ø–∞–º—è—Ç—å —Å–∏—Å—Ç–µ–º—ã. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ [–º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏](https://elixir.bootlin.com/linux/v6.15.5/source/Documentation/arch/x86/x86_64/mm.rst) –≤ `Documentation/arch/x86/x86_64/mm.rst`:
```
____________________________________________________________|___________________________________________________________
                  |            |                  |         |
 ffff800000000000 | -128    TB | ffff87ffffffffff |    8 TB | ... guard hole, also reserved for hypervisor
 ffff880000000000 | -120    TB | ffff887fffffffff |  0.5 TB | LDT remap for PTI
 ffff888000000000 | -119.5  TB | ffffc87fffffffff |   64 TB | direct mapping of all physical memory (page_offset_base)
 ffffc88000000000 |  -55.5  TB | ffffc8ffffffffff |  0.5 TB | ... unused hole
 ffffc90000000000 |  -55    TB | ffffe8ffffffffff |   32 TB | vmalloc/ioremap space (vmalloc_base)
 ffffe90000000000 |  -23    TB | ffffe9ffffffffff |    1 TB | ... unused hole
 ffffea0000000000 |  -22    TB | ffffeaffffffffff |    1 TB | virtual memory map (vmemmap_base)
 ffffeb0000000000 |  -21    TB | ffffebffffffffff |    1 TB | ... unused hole
 ffffec0000000000 |  -20    TB | fffffbffffffffff |   16 TB | KASAN shadow memory
__________________|____________|__________________|_________|____________________________________________________________
```

–°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –∫–æ–≥–¥–∞ –º–Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å UAF-–∑–∞–ø–∏—Å—å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —É–∫–∞–∑–∞—Ç–µ–ª—å `pipe_buffer.page`, —è –ø–æ–ª—É—á–∏–ª –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª —á–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å —è–¥–µ—Ä–Ω—É—é –ø–∞–º—è—Ç—å –ø–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º—É –∞–¥—Ä–µ—Å—É (Arbitrary Address Reading and Writing, AARW). –û–¥–Ω–∞–∫–æ —è –Ω–µ –º–æ–≥ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –º–µ–Ω—è—Ç—å —Ü–µ–ª–µ–≤–æ–π –∞–¥—Ä–µ—Å –¥–ª—è AARW (—Å–º. **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ‚Ññ 5**), –ø–æ—ç—Ç–æ–º—É —Ü–µ–ª—å –≤–Ω—É—Ç—Ä–∏ `vmemmap` –ø—Ä–∏—à–ª–æ—Å—å –≤—ã–±–∏—Ä–∞—Ç—å –æ—á–µ–Ω—å —Ç—â–∞—Ç–µ–ª—å–Ω–æ.

–ü–µ—Ä–≤–æ–π –º—ã—Å–ª—å—é –±—ã–ª–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —á–∞—Å—Ç—å –∫–æ–¥–∞ —è–¥—Ä–∞. –ù–æ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º KASLR —è –Ω–µ –∑–Ω–∞–ª —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å —Å–µ–≥–º–µ–Ω—Ç–∞ `_text` –∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –Ω–µ –º–æ–≥ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –µ–≥–æ –ø–æ–∑–∏—Ü–∏—é –≤–Ω—É—Ç—Ä–∏ `vmemmap`.

–ü–æ—ç—Ç–æ–º—É —è —Ä–µ—à–∏–ª –ø—Ä–∏–º–µ–Ω–∏—Ç—å AARW —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª –ø—Ä–æ—Ç–∏–≤ `struct cred` –≤ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏ —è–¥—Ä–∞ (–∫—É—á–µ). –†–∞–Ω–µ–µ —è —É–∂–µ –¥–æ–±—ã–ª –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å `cred` —á–µ—Ä–µ–∑ —á—Ç–µ–Ω–∏–µ –∑–∞ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –±—É—Ñ–µ—Ä–∞ –≤ `msg_msg`. –≠—Ç–æ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –∏–º–µ–ª –≤–∏–¥ `0xffff888003b7ad00`, –∏–∑ —á–µ–≥–æ —è –ø–æ–Ω—è–ª, —á—Ç–æ –æ–Ω –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø—Ä—è–º–æ–º—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏ (direct mapping). –î–∞–ª—å—à–µ —è —Ä–∞—Å—Å—á–∏—Ç–∞–ª —Å–º–µ—â–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π `struct page` –≤ `vmemmap` –ø–æ —Ñ–æ—Ä–º—É–ª–µ:
```c
#define STRUCT_PAGE_SZ 64lu
#define PAGE_ADDR_OFFSET(addr) (((addr & 0x3ffffffflu) >> 12) * STRUCT_PAGE_SZ)
uaf_val = PAGE_ADDR_OFFSET(cred_addr);
```

–ò–¥–µ—è –ø—Ä–æ—Å—Ç–∞:
- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ `addr & 0x3ffffffflu` –¥–∞–µ—Ç —Å–º–µ—â–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ `struct cred` –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—á–∞–ª–∞ –ø—Ä—è–º–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ (`page_offset_base`).
- –°–¥–≤–∏–≥ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤–ø—Ä–∞–≤–æ –Ω–∞ 12 –±–∏—Ç –¥–∞–µ—Ç –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–∞–º—è—Ç–∏, –≥–¥–µ –ª–µ–∂–∏—Ç `struct cred`.
- –ù–∞–∫–æ–Ω–µ—Ü, —É–º–Ω–æ–∂–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ 64 (—ç—Ç–æ —Ä–∞–∑–º–µ—Ä `struct page`) –¥–∞–µ—Ç —Å–º–µ—â–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ `struct page` –≤ `vmemmap`.

–≠—Ç—É —Ñ–æ—Ä–º—É–ª—É –Ω—É–∂–Ω–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ –±–æ–ª–µ–µ 4 –ì–∏–ë –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏. –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ `ZONE_NORMAL`, –≥–¥–µ —è–¥—Ä–æ –∞–ª–ª–æ—Ü–∏—Ä—É–µ—Ç —Å–≤–æ–∏ –æ–±—ä–µ–∫—Ç—ã, –æ–±—ã—á–Ω–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∞–¥—Ä–µ—Å–∞ `0x100000000`. –°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–º–µ—â–µ–Ω–∏–µ –Ω—É–∂–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ `struct page`, –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–±–∞–≤–ª—è–µ–º `(0x100000000 >> 12) * STRUCT_PAGE_SZ`.

–û—Ç–ª–∏—á–Ω–æ! –≠—Ç–∞ —Ñ–æ—Ä–º—É–ª–∞ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç KASLR –¥–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∞–¥—Ä–µ—Å–æ–≤. –ó–Ω–∞—á–∏—Ç, –ø–æ –Ω–µ–π –º–æ–∂–Ω–æ —Ç–æ—á–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å –º–ª–∞–¥—à–∏–µ —á–µ—Ç—ã—Ä–µ –±–∞–π—Ç–∞ –∞–¥—Ä–µ—Å–∞ `struct cred` –≤ `vmemmap`, —á—Ç–æ–±—ã –Ω–∞–ø—Ä–∞–≤–∏—Ç—å —Ç—É–¥–∞ AARW —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª. –ü–æ—á–µ–º—É –º–Ω–µ –Ω—É–∂–Ω—ã –±—ã–ª–∏ —Ç–æ–ª—å–∫–æ —á–µ—Ç—ã—Ä–µ –º–ª–∞–¥—à–∏—Ö –±–∞–π—Ç–∞ `pipe_buffer.page`?
- –ú–æ—è UAF-–∑–∞–ø–∏—Å—å –≤ `peer_buf_alloc` –º–µ–Ω—è–ª–∞ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é –ø–æ–ª–æ–≤–∏–Ω—É —É–∫–∞–∑–∞—Ç–µ–ª—è `pipe_buffer.page` (—ç—Ç–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è partial overwriting, —Å–º. —Å—Ö–µ–º—É –≤—ã—à–µ).
- –í `x86_64` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Ä—è–¥–æ–∫ –±–∞–π—Ç–æ–≤ little-endian, –ø–æ—ç—Ç–æ–º—É –ø–µ—Ä–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ —É–∫–∞–∑–∞—Ç–µ–ª—è —Å–æ–¥–µ—Ä–∂–∏—Ç —á–µ—Ç—ã—Ä–µ –º–ª–∞–¥—à–∏—Ö –±–∞–π—Ç–∞ –∞–¥—Ä–µ—Å–∞.

–ù–æ –∫–æ–≥–¥–∞ —è –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥, –º–µ—Ö–∞–Ω–∏–∑–º KASLR –Ω–∞–Ω–µ—Å –ø–æ—Å–ª–µ–¥–Ω–∏–π —É–¥–∞—Ä: –æ–Ω —Ä–∞–Ω–¥–æ–º–∏–∑–∏—Ä–æ–≤–∞–ª –∞–¥—Ä–µ—Å `vmemmap_base`, –∏ –≤ —á–µ—Ç—ã—Ä–µ—Ö –º–ª–∞–¥—à–∏—Ö –±–∞–π—Ç–∞—Ö —É–∫–∞–∑–∞—Ç–µ–ª–µ–π –Ω–∞ `struct page` –æ–∫–∞–∑–∞–ª–∏—Å—å **–¥–≤–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö –±–∏—Ç–∞**. –û—Ö, –∑–∞—Å–∞–¥–∞!

–¢–µ–º –Ω–µ –º–µ–Ω–µ–µ, —è —Ä–µ—à–∏–ª —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–±–æ—Ä —ç—Ç–∏—Ö –¥–≤—É—Ö –±–∏—Ç–æ–≤ (—Ç–æ –µ—Å—Ç—å 4 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤), –≤–µ–¥—å —É –º–µ–Ω—è –±—ã–ª–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–∫–æ–ª–æ –ø—è—Ç–∏ UAF-–∑–∞–ø–∏—Å–µ–π –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ kworker —Å–ª–æ–≤–∏—Ç null-ptr-deref –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ 8 —Å–µ–∫—É–Ω–¥ (`VSOCK_CLOSE_TIMEOUT`).

<center><img src="/img/bruteforce4-ru.jpg" width="60%"></center><br>

–Ø –æ–±–Ω–∞—Ä—É–∂–∏–ª, —á—Ç–æ ¬´–ø—Ä–æ—â—É–ø—ã–≤–∞–Ω–∏–µ¬ª —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π `pipe_buffer.page` –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –í —Å–ª—É—á–∞–µ –Ω–µ—É–¥–∞—á–∏ —á—Ç–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Bad address`.
- –í —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞ —á—Ç–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ –≤—ã–¥–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `struct cred`.

–¢–æ, —á—Ç–æ –Ω–∞–¥–æ! –ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ —è —Å–º–æ–≥ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ü–µ–ª–µ–≤–æ–π –∞–¥—Ä–µ—Å –¥–ª—è AARW, –∑–∞–ø–∏—Å–∞—Ç—å –≤ –∫–∞–Ω–∞–ª –∏ —Ç–µ–º —Å–∞–º—ã–º –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª—è `euid` –∏ `egid` –≤ `struct cred` –Ω—É–ª—è–º–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∞ root. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é –≤–∞–º [–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é](https://www.youtube.com/watch?v=qC95zkYnwb0) –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ —ç–∫—Å–ø–ª–æ–π—Ç–∞ –¥–ª—è CVE-2024-50264.

<div style="position:relative;padding-top:56.25%;">
  <iframe src="https://www.youtube.com/embed/qC95zkYnwb0" frameborder="0" allowfullscreen
    style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe>
</div>
<br/>

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ö–∞–∫ –∏ –¥–ª—è —É—á–µ–Ω—ã—Ö, –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å–æ–≤–µ—Ä—à–∏–≤—à–∏—Ö –æ—Ç–∫—Ä—ã—Ç–∏–µ, bug collision –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ‚Äî —ç—Ç–æ –±–æ–ª–µ–∑–Ω–µ–Ω–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è. –ù–æ –≤—Å–µ –∂–µ –±—ã–≤–∞–µ—Ç —Ä–∞–¥–æ—Å—Ç–Ω–æ, –µ—Å–ª–∏ –¥–æ–¥–µ–ª–∞—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∏ –Ω–∞ —á—Ç–æ. –ü—Ä–æ—Ü–∏—Ç–∏—Ä—É—é –º–æ–µ–≥–æ —Ö–æ—Ä–æ—à–µ–≥–æ –¥—Ä—É–≥–∞:

<center><img src="/img/yoda-ru.jpg" width="60%"></center><br>

–†–∞–±–æ—Ç–∞ —Å —ç—Ç–∏–º —Å–ª–æ–∂–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≥–æ–Ω–∫–∏ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ–º–æ–≥–ª–∞ –º–Ω–µ –∏–∑–æ–±—Ä–µ—Å—Ç–∏ –Ω–æ–≤—ã–µ –ø—Ä–∏–µ–º—ã —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –∏ –ø—Ä–æ–∫–∞—á–∞—Ç—å –º–æ–π –ø—Ä–æ–µ–∫—Ç [kernel-hack-drill](https://github.com/a13xp0p0v/kernel-hack-drill) ‚Äî —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ä–µ–¥—É –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —è–¥—Ä–∞ Linux. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å, –ø—Ä–æ–±—É–π—Ç–µ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ —É–ª—É—á—à–µ–Ω–∏—è!

–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–Ω–∏–º–∞–Ω–∏–µ.
